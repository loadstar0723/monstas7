name: Deploy to AWS

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Deploy to AWS Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: 15.165.105.250
        username: ubuntu
        key: ${{ secrets.AWS_SSH_KEY }}
        script: |
          cd /home/ubuntu/monstas7

          # Git pull ìµœì‹  ì½”ë“œ
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin master

          # Frontend ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd frontend

          # ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --legacy-peer-deps || npm install --legacy-peer-deps

          # PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          echo "ğŸ§¹ Cleaning up PM2 processes..."
          pm2 stop monsta-frontend || true
          pm2 delete monsta-frontend || true

          # ìºì‹œ ì •ë¦¬
          echo "ğŸ—‘ï¸ Clearing cache..."
          rm -rf .next
          rm -rf node_modules/.cache

          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export NODE_ENV=production
          export NODE_OPTIONS="--max-old-space-size=4096"

          # í”„ë¡œë•ì…˜ ë¹Œë“œ ì‹œë„
          echo "ğŸ—ï¸ Attempting production build..."
          if npm run build; then
            echo "âœ… Production build successful!"
            # í”„ë¡œë•ì…˜ ëª¨ë“œë¡œ ì‹¤í–‰
            pm2 start npm --name monsta-frontend -- run start -- -H 0.0.0.0 -p 3000
          else
            echo "âš ï¸ Production build failed, starting in development mode..."
            # ê°œë°œ ëª¨ë“œë¡œ ì‹¤í–‰ (í´ë°±)
            pm2 start "npx next dev -H 0.0.0.0 -p 3000" --name monsta-frontend
          fi

          # PM2 ì €ì¥ ë° ì„¤ì •
          pm2 save
          pm2 startup systemd -u ubuntu --hp /home/ubuntu || true

          echo "âœ… Deployment completed!"
          echo "ğŸŒ Server running at http://15.165.105.250:3000"
          pm2 status