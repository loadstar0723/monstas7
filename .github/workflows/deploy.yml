name: Zero-Downtime Deploy (ë¬´ì¤‘ë‹¨ ë°°í¬)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy-without-downtime:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: ğŸš€ ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹œì‘
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          script: |
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
            
            # ğŸ”„ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì „ëµ
            echo "ğŸ¯ ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹œì‘..."
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë²„ì „ í™•ì¸
            CURRENT_DIR="monstas7"
            NEW_DIR="monstas7_new"
            BACKUP_DIR="monstas7_backup"
            
            # 1ï¸âƒ£ ìƒˆ ë²„ì „ì„ ë³„ë„ ë””ë ‰í† ë¦¬ì— ì¤€ë¹„
            echo "ğŸ“¦ ìƒˆ ë²„ì „ ì¤€ë¹„ ì¤‘..."
            
            # ê¸°ì¡´ ìƒˆ ë””ë ‰í† ë¦¬ ì œê±°
            rm -rf ~/$NEW_DIR
            
            # í˜„ì¬ ë²„ì „ ë³µì‚¬ (node_modulesì™€ .next ìºì‹œ ë³´ì¡´)
            if [ -d ~/$CURRENT_DIR ]; then
              echo "ğŸ”„ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë³µì‚¬ ì¤‘..."
              cp -r ~/$CURRENT_DIR ~/$NEW_DIR
              cd ~/$NEW_DIR
            else
              echo "ğŸ†• ìƒˆ í”„ë¡œì íŠ¸ í´ë¡  ì¤‘..."
              git clone https://github.com/loadstar0723/monstas7.git ~/$NEW_DIR
              cd ~/$NEW_DIR
            fi
            
            # 2ï¸âƒ£ ìµœì‹  ì½”ë“œë§Œ ì—…ë°ì´íŠ¸ (ìºì‹œ ë³´ì¡´)
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            git fetch origin master
            git reset --hard origin/master
            
            # 3ï¸âƒ£ ì¦ë¶„ ì„¤ì¹˜ (ë³€ê²½ëœ íŒ¨í‚¤ì§€ë§Œ)
            cd frontend
            
            # package.jsonì´ ë³€ê²½ëœ ê²½ìš°ë§Œ ì„¤ì¹˜
            if ! diff package.json ../monstas7/frontend/package.json > /dev/null 2>&1; then
              echo "ğŸ“¦ ë³€ê²½ëœ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
              npm ci --prefer-offline --no-audit
            else
              echo "âœ… íŒ¨í‚¤ì§€ ë³€ê²½ ì—†ìŒ - ì„¤ì¹˜ ìŠ¤í‚µ"
            fi
            
            # 4ï¸âƒ£ Prisma ì¬ìƒì„± (ë¹ ë¦„)
            npx prisma generate
            
            # 5ï¸âƒ£ ì¦ë¶„ ë¹Œë“œ (ìºì‹œ í™œìš©)
            echo "ğŸ”¨ ì¦ë¶„ ë¹Œë“œ ì¤‘..."
            
            # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            cat > .env.production << 'EOF'
            NODE_ENV=production
            NEXTAUTH_SECRET=monstas7-secret-key-2024-production-secure
            NEXTAUTH_URL=http://13.209.84.93:3000
            DATABASE_URL="file:./prisma/dev.db"
            NEXT_PUBLIC_API_URL=http://13.209.84.93:3000/api
            EOF
            
            # ë¹Œë“œ (.next ìºì‹œ í™œìš©ìœ¼ë¡œ ë¹ ë¦„)
            npm run build
            
            # 6ï¸âƒ£ PM2 ìƒíƒœê³„ ì„¤ì • ì—…ë°ì´íŠ¸
            cat > ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'monsta-blue',
                script: 'npm',
                args: 'start',
                cwd: './frontend',
                instances: 1,
                exec_mode: 'fork',
                autorestart: true,
                watch: false,
                max_memory_restart: '600M',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3001,  // ë¸”ë£¨ ë²„ì „ì€ 3001 í¬íŠ¸
                  NEXT_TELEMETRY_DISABLED: 1,
                  HOST: '0.0.0.0'
                }
              }]
            }
            EOF
            
            # 7ï¸âƒ£ ìƒˆ ë²„ì „ì„ ë‹¤ë¥¸ í¬íŠ¸(3001)ì—ì„œ ì‹œì‘
            echo "ğŸ”µ ë¸”ë£¨ ë²„ì „ ì‹œì‘ ì¤‘..."
            pm2 delete monsta-blue 2>/dev/null || true
            pm2 start ecosystem.config.js
            
            # 8ï¸âƒ£ ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬ (ìµœëŒ€ 30ì´ˆ ëŒ€ê¸°)
            echo "ğŸ¥ ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬..."
            for i in {1..30}; do
              if curl -f http://localhost:3001 > /dev/null 2>&1; then
                echo "âœ… ìƒˆ ë²„ì „ ì •ìƒ ì‘ë™ í™•ì¸!"
                break
              fi
              echo "â³ ëŒ€ê¸° ì¤‘... ($i/30)"
              sleep 1
            done
            
            # 9ï¸âƒ£ íŠ¸ë˜í”½ ì „í™˜ (ì‹¬ë³¼ë¦­ ë§í¬ êµì²´)
            echo "ğŸ”„ íŠ¸ë˜í”½ ì „í™˜ ì¤‘..."
            
            # ë°±ì—… ìƒì„±
            if [ -d ~/$CURRENT_DIR ]; then
              rm -rf ~/$BACKUP_DIR
              mv ~/$CURRENT_DIR ~/$BACKUP_DIR
            fi
            
            # ì‹¬ë³¼ë¦­ ë§í¬ êµì²´ (ì›ìì  ì‘ì—…)
            mv ~/$NEW_DIR ~/$CURRENT_DIR
            
            # ğŸ”Ÿ ê¸°ì¡´ ë²„ì „ ì¢…ë£Œ ë° ìƒˆ ë²„ì „ì„ 3000 í¬íŠ¸ë¡œ ì „í™˜
            cd ~/$CURRENT_DIR/frontend
            
            # 3000 í¬íŠ¸ìš© ì„¤ì •
            cat > ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'monsta-prod',
                script: 'npm',
                args: 'start',
                cwd: './frontend',
                instances: 2,  // í´ëŸ¬ìŠ¤í„° ëª¨ë“œë¡œ 2ê°œ ì¸ìŠ¤í„´ìŠ¤
                exec_mode: 'cluster',  // í´ëŸ¬ìŠ¤í„° ëª¨ë“œ
                autorestart: true,
                watch: false,
                max_memory_restart: '600M',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000,
                  NEXT_TELEMETRY_DISABLED: 1,
                  HOST: '0.0.0.0'
                },
                wait_ready: true,
                listen_timeout: 10000,
                kill_timeout: 5000
              }]
            }
            EOF
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ í›„ ìƒˆë¡œ ì‹œì‘
            pm2 delete monsta-blue 2>/dev/null || true
            pm2 delete monsta-prod 2>/dev/null || true
            pm2 start ecosystem.config.js
            
            pm2 save
            pm2 startup || true
            
            # 1ï¸âƒ£1ï¸âƒ£ ìµœì¢… í™•ì¸
            echo "ğŸ‰ ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ!"
            echo "ğŸ“Š PM2 ìƒíƒœ:"
            pm2 status
            
            # ë°±ì—… ì •ë¦¬ (ì„ íƒì )
            if [ -d ~/$BACKUP_DIR ]; then
              echo "ğŸ—‘ï¸ ì´ì „ ë°±ì—… ì œê±° ì¤‘..."
              rm -rf ~/$BACKUP_DIR
            fi
            
            echo "âœ… ë°°í¬ ì™„ë£Œ ì‹œê°„: $(date)"
            echo "ğŸŒ ì„œë¹„ìŠ¤ URL: http://13.209.84.93:3000"
      
      - name: âœ… ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.DEPLOY_TELEGRAM_CHAT_ID }}
          token: ${{ secrets.DEPLOY_TELEGRAM_BOT_TOKEN }}
          message: |
            âœ… ë¬´ì¤‘ë‹¨ ë°°í¬ ì„±ê³µ!
            
            ğŸš€ ë‹¤ìš´íƒ€ì„: 0ì´ˆ
            ğŸ“ ì»¤ë°‹: ${{ github.event.head_commit.message }}
            ğŸŒ URL: http://13.209.84.93:3000
            
            ì„œë²„ê°€ í•œ ë²ˆë„ ëŠê¸°ì§€ ì•Šê³  ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!