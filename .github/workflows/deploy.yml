name: Zero-Downtime Deploy (무중단 배포)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: 🚀 배포 시작
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          script: |
            echo "🎯 배포 시작..."
            
            # 프로젝트 디렉토리 확인 및 생성
            PROJECT_DIR="$HOME/monstas7"
            
            # 프로젝트가 없으면 클론
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "📦 프로젝트 클론 중..."
              git clone https://github.com/loadstar0723/monstas7.git "$PROJECT_DIR"
            fi
            
            # 프로젝트 디렉토리로 이동
            cd "$PROJECT_DIR"
            
            # 최신 코드 가져오기
            echo "📥 최신 코드 가져오는 중..."
            git fetch origin master
            git reset --hard origin/master
            
            # Frontend 디렉토리로 이동
            cd frontend
            
            # 패키지 설치
            echo "📦 패키지 설치 중..."
            npm ci || npm install
            
            # Prisma 생성
            echo "🔧 Prisma 생성 중..."
            npx prisma generate
            
            # 환경변수 설정
            echo "⚙️ 환경변수 설정 중..."
            cat > .env.production << 'EOF'
            NODE_ENV=production
            NEXTAUTH_SECRET=monstas7-secret-key-2024-production-secure
            NEXTAUTH_URL=http://13.209.84.93:3000
            DATABASE_URL="file:./prisma/dev.db"
            NEXT_PUBLIC_API_URL=http://13.209.84.93:3000/api
            EOF
            
            # 빌드
            echo "🔨 빌드 중..."
            npm run build
            
            # PM2 설정
            echo "🔄 PM2 설정 중..."
            cat > ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'monsta-prod',
                script: 'npm',
                args: 'start',
                cwd: './',
                instances: 1,
                exec_mode: 'fork',
                autorestart: true,
                watch: false,
                max_memory_restart: '1G',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000,
                  NEXT_TELEMETRY_DISABLED: 1,
                  HOST: '0.0.0.0'
                }
              }]
            }
            EOF
            
            # PM2로 앱 재시작
            echo "🚀 앱 재시작 중..."
            pm2 stop monsta-prod 2>/dev/null || true
            pm2 delete monsta-prod 2>/dev/null || true
            pm2 start ecosystem.config.js
            
            # PM2 저장
            pm2 save
            pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
            
            # 상태 확인
            echo "📊 PM2 상태:"
            pm2 status
            
            echo "✅ 배포 완료!"
            echo "🌐 서비스 URL: http://13.209.84.93:3000"
      
      - name: ✅ 배포 성공 알림
        if: success()
        run: echo "배포가 성공적으로 완료되었습니다!"