name: Zero-Downtime Deploy (ë¬´ì¤‘ë‹¨ ë°°í¬)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: ğŸš€ ë°°í¬ ì‹œì‘
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          script: |
            echo "ğŸ¯ ë°°í¬ ì‹œì‘..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
            PROJECT_DIR="$HOME/monstas7"
            
            # í”„ë¡œì íŠ¸ê°€ ì—†ìœ¼ë©´ í´ë¡ 
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ğŸ“¦ í”„ë¡œì íŠ¸ í´ë¡  ì¤‘..."
              git clone https://github.com/loadstar0723/monstas7.git "$PROJECT_DIR"
            fi
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd "$PROJECT_DIR"
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            git fetch origin master
            git reset --hard origin/master
            
            # Frontend ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd frontend
            
            # íŒ¨í‚¤ì§€ ì„¤ì¹˜
            echo "ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
            npm ci || npm install
            
            # Prisma ìƒì„±
            echo "ğŸ”§ Prisma ìƒì„± ì¤‘..."
            npx prisma generate
            
            # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            echo "âš™ï¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¤‘..."
            cat > .env.production << 'EOF'
            NODE_ENV=production
            NEXTAUTH_SECRET=monstas7-secret-key-2024-production-secure
            NEXTAUTH_URL=http://13.209.84.93:3000
            DATABASE_URL="file:./prisma/dev.db"
            NEXT_PUBLIC_API_URL=http://13.209.84.93:3000/api
            EOF
            
            # ë¹Œë“œ
            echo "ğŸ”¨ ë¹Œë“œ ì¤‘..."
            npm run build
            
            # PM2 ì„¤ì •
            echo "ğŸ”„ PM2 ì„¤ì • ì¤‘..."
            cat > ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'monsta-prod',
                script: 'npm',
                args: 'start',
                cwd: './',
                instances: 1,
                exec_mode: 'fork',
                autorestart: true,
                watch: false,
                max_memory_restart: '1G',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000,
                  NEXT_TELEMETRY_DISABLED: 1,
                  HOST: '0.0.0.0'
                }
              }]
            }
            EOF
            
            # PM2ë¡œ ì•± ì¬ì‹œì‘
            echo "ğŸš€ ì•± ì¬ì‹œì‘ ì¤‘..."
            pm2 stop monsta-prod 2>/dev/null || true
            pm2 delete monsta-prod 2>/dev/null || true
            pm2 start ecosystem.config.js
            
            # PM2 ì €ì¥
            pm2 save
            pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
            
            # ìƒíƒœ í™•ì¸
            echo "ğŸ“Š PM2 ìƒíƒœ:"
            pm2 status
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "ğŸŒ ì„œë¹„ìŠ¤ URL: http://13.209.84.93:3000"
      
      - name: âœ… ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: echo "ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"