name: Deploy to AWS

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Deploy to AWS Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: 15.165.105.250
        username: ubuntu
        key: ${{ secrets.AWS_SERVER_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 30m
        script: |
          # 에러 발생 시 즉시 중단
          set -e
          cd /home/ubuntu/monstas7

          # Git pull 최신 코드
          echo "📥 Pulling latest code..."
          git pull origin master

          # Frontend 디렉토리로 이동
          cd frontend

          # 의존성 설치
          echo "📦 Installing dependencies..."
          npm ci --legacy-peer-deps || npm install --legacy-peer-deps

          # PM2 프로세스 정리
          echo "🧹 Cleaning up PM2 processes..."
          pm2 stop monsta-frontend || true
          pm2 delete monsta-frontend || true

          # 캐시 정리
          echo "🗑️ Clearing cache..."
          rm -rf .next
          rm -rf node_modules/.cache

          # 환경 변수 설정
          export NODE_ENV=production
          export NODE_OPTIONS="--max-old-space-size=4096"

          # 프로덕션 빌드 시도
          echo "🏗️ Attempting production build..."
          if npm run build; then
            echo "✅ Production build successful!"
            # 프로덕션 모드로 실행
            pm2 start npm --name monsta-frontend -- run start -- -H 0.0.0.0 -p 3000
          else
            echo "⚠️ Production build failed, starting in development mode..."
            # 개발 모드로 실행 (폴백)
            pm2 start "npx next dev -H 0.0.0.0 -p 3000" --name monsta-frontend
          fi

          # PM2 저장 및 설정
          pm2 save
          pm2 startup systemd -u ubuntu --hp /home/ubuntu || true

          # PM2 상태 확인
          pm2 status

          # 서버 시작 대기
          echo "⏳ Waiting for server to start..."
          sleep 5

          # 헬스체크
          echo "🏥 Running health check..."
          for i in {1..10}; do
            if curl -f -s http://localhost:3000 > /dev/null; then
              echo "✅ Server is responding!"
              echo "🎉 Deployment completed successfully!"
              echo "🌐 Server running at http://15.165.105.250:3000"
              exit 0
            else
              echo "⏳ Waiting for server... ($i/10)"
              sleep 3
            fi
          done

          echo "❌ Server failed to start!"
          pm2 logs --lines 50
          exit 1