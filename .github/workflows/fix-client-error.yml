name: Fix Client Error

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - 'fix-client.trigger'

jobs:
  fix:
    runs-on: ubuntu-latest
    
    steps:
      - name: Fix Client Side Error
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          timeout: 30m
          script: |
            echo "ðŸ”§ í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬ ìˆ˜ì • ì‹œìž‘..."
            
            # 1. í˜„ìž¬ í”„ë¡œì„¸ìŠ¤ í™•ì¸
            echo "í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤:"
            ps aux | grep node | grep -v grep
            
            # 2. PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            
            # 3. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/monstas7/frontend
            
            # 4. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
            git pull origin master
            
            # 5. ìºì‹œ ì •ë¦¬
            echo "ìºì‹œ ì •ë¦¬..."
            rm -rf .next
            
            # 6. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            echo "í™˜ê²½ ë³€ìˆ˜ ì„¤ì •..."
            cat > .env.local << 'EOF'
            NEXTAUTH_SECRET=monstas7-secret-key-2024
            NEXTAUTH_URL=http://13.209.84.93:3000
            DATABASE_URL="file:./dev.db"
            NODE_ENV=development
            EOF
            
            # 7. ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ì˜ì¡´ì„± í™•ì¸..."
            npm install
            
            # 8. Prisma ì„¤ì •
            npx prisma generate
            
            # 9. PM2ë¡œ ê°œë°œ ëª¨ë“œ ì‹¤í–‰
            echo "PM2ë¡œ ê°œë°œ ì„œë²„ ì‹œìž‘..."
            pm2 start "npm run dev" --name monsta-dev
            pm2 save
            
            # 10. ë¡œê·¸ í™•ì¸
            echo "PM2 ë¡œê·¸:"
            pm2 logs --lines 30 --nostream
            
            # 11. ìƒíƒœ í™•ì¸
            echo "PM2 ìƒíƒœ:"
            pm2 status
            
            # 12. í¬íŠ¸ í™•ì¸
            echo "í¬íŠ¸ 3000 ìƒíƒœ:"
            sudo netstat -tlnp | grep :3000
            
            echo "âœ… í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬ ìˆ˜ì • ì™„ë£Œ"
            echo "ðŸŒ ì ‘ì† ì£¼ì†Œ: http://13.209.84.93:3000"
            echo "ðŸ“‹ ë¹„ì •ìƒ ì˜µì…˜ íŽ˜ì´ì§€: http://13.209.84.93:3000/signals/unusual-options"