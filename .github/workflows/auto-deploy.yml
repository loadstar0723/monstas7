name: ðŸš€ ê°„ë‹¨ ìžë™ ë°°í¬

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸš€ ì„œë²„ì— ë°°í¬
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          script: |
            echo "ðŸš€ ìžë™ ë°°í¬ ì‹œìž‘ - $(date)"
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ubuntu/monstas7
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ðŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            git pull origin master
            
            # íŒŒì¼ íƒ€ìž„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
            echo "ðŸ• íŒŒì¼ íƒ€ìž„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸ ì¤‘..."
            find . -type f \( -name "*.tsx" -o -name "*.ts" -o -name "*.jsx" -o -name "*.js" \) -exec touch {} \;
            
            # Frontend ë¹Œë“œ
            cd frontend
            echo "ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            npm install --legacy-peer-deps
            
            echo "ðŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ ì¤‘..."
            npm run build
            
            # PM2 ìž¬ì‹œìž‘
            echo "ðŸ”„ ì• í”Œë¦¬ì¼€ì´ì…˜ ìž¬ì‹œìž‘ ì¤‘..."
            pm2 restart monstas7 || pm2 start npm --name monstas7 -- start
            pm2 save
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            pm2 status
            
            # ë°°í¬ ì„±ê³µ ë¡œê·¸
            echo "[$(date)] ë°°í¬ ì„±ê³µ - ì»¤ë°‹: $GITHUB_SHA" >> /home/ubuntu/monstas7/logs/deployment.log
            
            # ë°°í¬ ê²°ê³¼ í™•ì¸
            if curl -f http://localhost > /dev/null 2>&1; then
              echo "ðŸŽ‰ ì‚¬ì´íŠ¸ ì •ìƒ ìž‘ë™ í™•ì¸!"
            else
              echo "âŒ ì‚¬ì´íŠ¸ ì—°ê²° ì‹¤íŒ¨!" >&2
              exit 1
            fi