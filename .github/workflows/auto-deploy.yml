name: ğŸš€ ê°„ë‹¨ ìë™ ë°°í¬

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ ì„œë²„ì— ë°°í¬
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          script: |
            echo "ğŸš€ ìë™ ë°°í¬ ì‹œì‘ - $(date)"
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ubuntu/monstas7
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            git pull origin master
            
            # íŒŒì¼ íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
            echo "ğŸ• íŒŒì¼ íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸ ì¤‘..."
            find . -type f \( -name "*.tsx" -o -name "*.ts" -o -name "*.jsx" -o -name "*.js" \) -exec touch {} \;
            
            # Frontend ë¹Œë“œ
            cd frontend
            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            npm install --legacy-peer-deps
            
            echo "ğŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ ì¤‘..."
            npm run build
            
            # PM2 ì¬ì‹œì‘
            echo "ğŸ”„ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ ì¤‘..."
            pm2 restart monstas7 || pm2 start npm --name monstas7 -- start
            pm2 save
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            pm2 status