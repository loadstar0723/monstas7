name: ğŸ”§ Fix Build and Deploy

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  fix-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ ì„œë²„ ë¹Œë“œ ë° ë°°í¬
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USER }}
        key: ${{ secrets.AWS_SSH_KEY }}
        script: |
          echo "ğŸ”„ ë¹Œë“œ ìˆ˜ì • ì‹œì‘..."
          
          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          pm2 kill || true
          sudo pkill -f node || true
          sudo pkill -f npm || true
          
          # í¬íŠ¸ ì •ë¦¬
          sudo fuser -k 3000/tcp || true
          sudo fuser -k 8000/tcp || true
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬
          cd /home/ubuntu/monstas7 || exit 1
          
          # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          git fetch origin
          git reset --hard origin/master
          git pull origin master
          
          # Frontend ë¹Œë“œ
          cd frontend
          
          # ê¸°ì¡´ ë¹Œë“œ ë° ìºì‹œ ì œê±°
          rm -rf .next
          rm -rf node_modules/.cache
          
          # íŒ¨í‚¤ì§€ ì¬ì„¤ì¹˜
          npm ci || npm install
          
          # Prisma ìƒì„±
          npx prisma generate || true
          
          # í”„ë¡œë•ì…˜ ë¹Œë“œ
          npm run build || {
            echo "âŒ ë¹Œë“œ ì‹¤íŒ¨. ê°œë°œ ëª¨ë“œë¡œ ì‹¤í–‰..."
            # ê°œë°œ ëª¨ë“œë¡œ ì‹¤í–‰
            pm2 start "npm run dev" --name frontend-dev -- --port 3000
            pm2 save
            exit 0
          }
          
          # í”„ë¡œë•ì…˜ ëª¨ë“œë¡œ ì‹¤í–‰
          pm2 start "npm run start" --name frontend -- --port 3000
          
          # PM2 ì„¤ì • ì €ì¥
          pm2 save
          pm2 startup systemd -u ubuntu --hp /home/ubuntu
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          
          # ìƒíƒœ í™•ì¸
          pm2 status
          sleep 5
          
          # í—¬ìŠ¤ì²´í¬
          curl -I http://localhost:3000 || echo "ì„œë²„ ì‹œì‘ ì¤‘..."