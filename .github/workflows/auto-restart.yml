name: ğŸ”„ Auto Server Restart

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - 'frontend/**'
      - '.github/workflows/auto-restart.yml'

jobs:
  restart:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ ì„œë²„ ìë™ ì¬ì‹œì‘
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USER }}
        key: ${{ secrets.AWS_SSH_KEY }}
        script: |
          echo "ğŸ”„ ì„œë²„ ì¬ì‹œì‘ ì‹œì‘..."
          
          # ëª¨ë“  Node í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
          sudo pkill -f node || true
          sudo pkill -f npm || true
          sudo pkill -f next || true
          
          # PM2ë¡œ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          pm2 kill || true
          
          # í¬íŠ¸ ì ìœ  í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          sudo fuser -k 3000/tcp || true
          sudo fuser -k 8000/tcp || true
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /home/ubuntu/monstas7 || exit 1
          
          # ìµœì‹  ì½”ë“œ pull
          git pull origin master
          
          # Frontend ì¬ì‹œì‘
          cd frontend
          npm install
          
          # PM2ë¡œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
          pm2 start "npm run start" --name frontend -- --port 3000
          
          # PM2 ìƒíƒœ ì €ì¥
          pm2 save
          pm2 startup systemd -u ubuntu --hp /home/ubuntu
          
          echo "âœ… ì„œë²„ ì¬ì‹œì‘ ì™„ë£Œ!"
          
          # ìƒíƒœ í™•ì¸
          pm2 status
          curl -I http://localhost:3000 || echo "ì„œë²„ ì‹œì‘ ì¤‘..."