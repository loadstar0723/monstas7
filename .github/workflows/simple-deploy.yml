name: Simple Deploy to AWS

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          timeout: 30m
          command_timeout: 30m
          script: |
            # ê°„ë‹¨í•œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
            echo "ğŸš€ Starting deployment..."
            
            # í”„ë¡œì íŠ¸ ê²½ë¡œ ì°¾ê¸°
            if [ -d ~/monstas7 ]; then
              cd ~/monstas7
            elif [ -d ~/monsta-v7/monstas7 ]; then
              cd ~/monsta-v7/monstas7
            elif [ -d ~/monsta-ai-trading ]; then
              cd ~/monsta-ai-trading
            else
              echo "âŒ Project directory not found!"
              echo "Creating new project directory..."
              cd ~
              git clone https://github.com/loadstar0723/monstas7.git
              cd monstas7
            fi
            
            echo "ğŸ“ Current directory: $(pwd)"
            
            # Git pull
            echo "ğŸ“¥ Pulling latest code..."
            git fetch --all
            git reset --hard origin/master
            
            # Frontend ë°°í¬
            echo "ğŸ¨ Deploying frontend..."
            cd frontend
            
            # Node.js í™•ì¸
            node -v || {
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            }
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ Installing dependencies..."
            npm install
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            echo "ğŸ”§ Setting environment variables..."
            cat > .env.local << 'EOF'
            NEXTAUTH_SECRET=monstas7-secret-key-2024-production-secure
            NEXTAUTH_URL=http://13.209.84.93:3000
            DATABASE_URL="file:./dev.db"
            EOF
            
            # Prisma ìƒì„±
            echo "ğŸ”§ Generating Prisma client..."
            npx prisma generate || echo "Prisma generate skipped"
            
            # ë¹Œë“œ
            echo "ğŸ—ï¸ Building application..."
            npm run build || {
              echo "âŒ Build failed!"
              echo "Showing error logs..."
              tail -n 50 ~/.npm/_logs/*.log 2>/dev/null || true
              exit 1
            }
            
            # PM2 ì„¤ì¹˜ í™•ì¸
            which pm2 || {
              echo "Installing PM2..."
              sudo npm install -g pm2
            }
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            echo "ğŸ”„ Stopping existing processes..."
            pm2 stop all || true
            pm2 delete all || true
            pkill -f "next start" || true
            pkill -f "node" || true
            
            # ì•± ì‹œì‘
            echo "ğŸš€ Starting application..."
            cd ~/monstas7/frontend || cd frontend
            export NODE_ENV=production
            export PORT=3000
            # PM2ë¡œ ì‹œì‘
            pm2 start npm --name monstas7 -- start || {
              echo "PM2 start failed, trying direct start..."
              nohup npm start > ~/app.log 2>&1 &
            }
            pm2 save || true
            
            # í”„ë¡œì„¸ìŠ¤ í™•ì¸
            sleep 5
            ps aux | grep "next start" | grep -v grep || echo "Warning: Process may not have started"
            
            # ë°©í™”ë²½ ì„¤ì • í™•ì¸
            echo "ğŸ”¥ Checking firewall..."
            sudo ufw allow 3000/tcp || true
            sudo ufw status || true
            
            # ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Checking status..."
            pm2 status
            
            echo "âœ… Deployment completed!"
            echo "ğŸŒ Site: http://13.209.84.93:3000"