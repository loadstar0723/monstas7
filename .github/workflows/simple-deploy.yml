name: Simple Deploy

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Server
        env:
          DEPLOY_KEY: ${{ secrets.AWS_SERVER_KEY }}
        run: |
          # SSH í‚¤ ì„¤ì •
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Known hosts ì¶”ê°€
          ssh-keyscan -H 15.165.105.250 >> ~/.ssh/known_hosts
          
          # ë°°í¬ ì‹¤í–‰ (ì—ëŸ¬ ì‹œ ì¦‰ì‹œ ì‹¤íŒ¨)
          ssh -i ~/.ssh/deploy_key ubuntu@15.165.105.250 << 'EOF'
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

            echo "ğŸš€ Starting deployment..."

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸
            cd ~/monstas7 || { echo "âŒ Project not found"; exit 1; }

            # Git ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ Pulling latest code..."
            git fetch --all
            git reset --hard origin/master

            # Frontend ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd frontend

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo "ğŸ§¹ Cleaning up old processes..."
            pm2 delete monsta-prod 2>/dev/null || true
            pm2 delete monsta-frontend 2>/dev/null || true

            # ìºì‹œ ì •ë¦¬
            rm -rf .next
            rm -rf node_modules/.cache

            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ Installing dependencies..."
            npm install --legacy-peer-deps

            # react-is íŒ¨í‚¤ì§€ í™•ì¸ (í•„ìˆ˜)
            npm list react-is || npm install react-is --save

            # ë¹Œë“œ ì‹œë„
            echo "ğŸ—ï¸ Attempting production build..."
            if npm run build; then
              echo "âœ… Build successful! Starting production server..."
              pm2 start npm --name monsta-prod -- start -- -H 0.0.0.0 -p 3000
            else
              echo "âš ï¸ Build failed! Starting in development mode..."
              pm2 start "npx next dev -H 0.0.0.0 -p 3000" --name monsta-frontend
            fi

            # PM2 ì„¤ì • ì €ì¥
            pm2 save

            # ì„œë²„ ì‹œì‘ ëŒ€ê¸°
            echo "â³ Waiting for server to start..."
            sleep 5

            # PM2 ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Checking PM2 status..."
            pm2 list

            # ì„œë²„ í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ Running health check..."
            for i in {1..10}; do
              if curl -f -s http://localhost:3000 > /dev/null; then
                echo "âœ… Server is responding!"
                break
              else
                echo "â³ Waiting for server... ($i/10)"
                sleep 3
              fi

              if [ $i -eq 10 ]; then
                echo "âŒ Server failed to start!"
                pm2 logs --lines 50
                exit 1
              fi
            done

            # í¬íŠ¸ í™•ì¸
            if netstat -tlpn 2>/dev/null | grep -q :3000; then
              echo "âœ… Port 3000 is listening!"
            else
              echo "âŒ Port 3000 is NOT listening!"
              pm2 logs --lines 30
              exit 1
            fi

            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸŒ Server is running at http://15.165.105.250:3000"
          EOF