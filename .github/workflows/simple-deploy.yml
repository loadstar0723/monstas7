name: Simple Deploy

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Server
        env:
          DEPLOY_KEY: ${{ secrets.AWS_SERVER_KEY }}
        run: |
          # SSH 키 설정
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Known hosts 추가
          ssh-keyscan -H 15.165.105.250 >> ~/.ssh/known_hosts
          
          # 배포 실행
          ssh -i ~/.ssh/deploy_key ubuntu@15.165.105.250 << 'EOF'
            echo "Starting deployment..."
            
            # 프로젝트 디렉토리 확인
            cd ~/monstas7 || { echo "Project not found"; exit 1; }
            
            # Git 최신 코드 가져오기
            git fetch --all
            git reset --hard origin/master
            
            # Frontend 디렉토리로 이동
            cd frontend
            
            # 캐시 정리
            rm -rf .next
            rm -rf node_modules/.cache
            
            # 의존성 설치
            npm install
            
            # 빌드
            echo "Building production..."
            npm run build
            
            # PM2 완전 재시작 (포트 3000 명시)
            pm2 delete monsta-prod || true
            PORT=3000 pm2 start npm --name monsta-prod -- start
            pm2 save
            
            # 프로세스 확인
            sleep 3
            pm2 list
            
            # 포트 확인
            netstat -tlpn | grep :3000 || echo "WARNING: Port 3000 not listening!"
            
            echo "Deployment completed!"
          EOF