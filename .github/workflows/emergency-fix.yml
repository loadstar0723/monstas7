name: Emergency Fix & Deploy

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  emergency-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Emergency Deploy with Cache Clear
        env:
          DEPLOY_KEY: ${{ secrets.AWS_SERVER_KEY }}
        run: |
          # SSH í‚¤ ì„¤ì •
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Known hosts ì¶”ê°€
          ssh-keyscan -H 15.165.105.250 >> ~/.ssh/known_hosts
          
          # ë°°í¬ ì‹¤í–‰ (ìºì‹œ ì™„ì „ ì‚­ì œ í¬í•¨)
          ssh -i ~/.ssh/deploy_key ubuntu@15.165.105.250 << 'EOF'
            echo "ğŸš¨ Emergency deployment starting..."
            
            # í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€
            pm2 stop monsta-prod || true
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/monstas7 || { echo "Project not found"; exit 1; }
            
            # Git ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git fetch --all
            git reset --hard origin/master
            git pull origin master
            
            # Frontend ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd frontend
            
            # ëª¨ë“  ìºì‹œ ì‚­ì œ
            echo "ğŸ§¹ Clearing all caches..."
            rm -rf .next
            rm -rf node_modules/.cache
            rm -rf .cache
            
            # ì˜ì¡´ì„± ì¬ì„¤ì¹˜
            echo "ğŸ“¦ Reinstalling dependencies..."
            rm -rf node_modules
            npm cache clean --force
            npm install
            
            # ë¹Œë“œ
            echo "ğŸ—ï¸ Building production..."
            npm run build
            
            # PM2ë¡œ ì¬ì‹œì‘
            echo "ğŸš€ Starting server..."
            pm2 delete monsta-prod || true
            pm2 start npm --name monsta-prod -- start
            pm2 save
            pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
            
            # í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤ì œë¡œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
            sleep 5
            pm2 status
            
            # í¬íŠ¸ 3000ì´ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸
            echo "ğŸ“¡ Checking if port 3000 is listening..."
            netstat -tlpn | grep :3000 || echo "âš ï¸ Port 3000 is not listening!"
            
            # PM2 ë¡œê·¸ í™•ì¸
            echo "ğŸ“ PM2 logs:"
            pm2 logs monsta-prod --lines 20 --nostream
            
            # í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ ì‹œë„
            echo "ğŸ”„ Ensuring process is running..."
            pm2 restart monsta-prod || pm2 start npm --name monsta-prod -- start
            
            # ìµœì¢… ìƒíƒœ í™•ì¸
            pm2 list
            
            echo "âœ… Emergency deployment completed!"
          EOF