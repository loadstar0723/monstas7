name: Emergency Fix

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  fix:
    runs-on: ubuntu-latest
    
    steps:
      - name: Emergency Server Fix
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          timeout: 30m
          script: |
            echo "🚨 긴급 서버 수정 시작..."
            
            # 1. 완전히 정리
            sudo killall -9 node npm 2>/dev/null || true
            pm2 kill
            
            # 2. 프로젝트 재설치
            cd ~
            rm -rf monstas7_backup
            mv monstas7 monstas7_backup 2>/dev/null || true
            
            # 3. 새로 클론
            git clone https://github.com/loadstar0723/monstas7.git
            cd monstas7/frontend
            
            # 4. 환경 설정
            cat > .env.local << 'EOF'
            NEXTAUTH_SECRET=monstas7-secret-key-2024
            NEXTAUTH_URL=http://13.209.84.93:3000
            DATABASE_URL="file:./dev.db"
            EOF
            
            # 5. 설치 및 빌드
            npm install
            npx prisma generate
            
            # 빌드 시도 (실패해도 계속)
            npm run build || echo "빌드 실패, 개발 모드로 실행"
            
            # 6. 직접 실행 (PM2 없이)
            PORT=3000 HOST=0.0.0.0 nohup npm start > ~/server.log 2>&1 &
            
            # 7. 잠시 대기
            sleep 10
            
            # 8. 확인
            echo "서버 상태 확인:"
            curl -I http://localhost:3000/test || echo "테스트 페이지 접속 실패"
            
            echo "로그 확인:"
            tail -30 ~/server.log
            
            echo "✅ 긴급 수정 완료"