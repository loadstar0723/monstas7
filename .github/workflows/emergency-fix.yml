name: Emergency Fix & Deploy

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  emergency-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Emergency Deploy with Cache Clear
        env:
          DEPLOY_KEY: ${{ secrets.AWS_SERVER_KEY }}
        run: |
          # SSH 키 설정
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Known hosts 추가
          ssh-keyscan -H 15.165.105.250 >> ~/.ssh/known_hosts
          
          # 배포 실행 (캐시 완전 삭제 포함)
          ssh -i ~/.ssh/deploy_key ubuntu@15.165.105.250 << 'EOF'
            echo "🚨 Emergency deployment starting..."
            
            # 프로세스 중지
            pm2 stop monsta-prod || true
            
            # 프로젝트 디렉토리로 이동
            cd ~/monstas7 || { echo "Project not found"; exit 1; }
            
            # Git 최신 코드 가져오기
            git fetch --all
            git reset --hard origin/master
            git pull origin master
            
            # Frontend 디렉토리로 이동
            cd frontend
            
            # 모든 캐시 삭제
            echo "🧹 Clearing all caches..."
            rm -rf .next
            rm -rf node_modules/.cache
            rm -rf .cache
            
            # 의존성 재설치
            echo "📦 Reinstalling dependencies..."
            rm -rf node_modules
            npm cache clean --force
            npm install
            
            # 빌드
            echo "🏗️ Building production..."
            npm run build
            
            # PM2로 재시작
            echo "🚀 Starting server..."
            pm2 delete monsta-prod || true
            pm2 start npm --name monsta-prod -- start
            pm2 save
            pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
            
            # 프로세스가 실제로 실행 중인지 확인
            sleep 5
            pm2 status
            
            # 포트 3000이 열려있는지 확인
            echo "📡 Checking if port 3000 is listening..."
            netstat -tlpn | grep :3000 || echo "⚠️ Port 3000 is not listening!"
            
            # PM2 로그 확인
            echo "📝 PM2 logs:"
            pm2 logs monsta-prod --lines 20 --nostream
            
            # 프로세스 재시작 시도
            echo "🔄 Ensuring process is running..."
            pm2 restart monsta-prod || pm2 start npm --name monsta-prod -- start
            
            # 최종 상태 확인
            pm2 list
            
            echo "✅ Emergency deployment completed!"
          EOF