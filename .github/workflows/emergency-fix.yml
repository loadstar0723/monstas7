name: Emergency Fix (ë°±ì—…ìš©)

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ì „ìš©
    inputs:
      deployment_mode:
        description: 'Deployment Mode'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production
          - restart-only

jobs:
  emergency-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Emergency Deployment
        env:
          DEPLOY_KEY: ${{ secrets.AWS_SERVER_KEY }}
        run: |
          # SSH í‚¤ ì„¤ì •
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Known hosts ì¶”ê°€
          ssh-keyscan -H 15.165.105.250 >> ~/.ssh/known_hosts

          # ë°°í¬ ëª¨ë“œë³„ ì‹¤í–‰
          if [ "${{ inputs.deployment_mode }}" = "restart-only" ]; then
            echo "ğŸ”„ Restarting server only..."
            ssh -i ~/.ssh/deploy_key ubuntu@15.165.105.250 << 'EOF'
              cd ~/monstas7/frontend
              pm2 restart all || pm2 start "npx next dev -H 0.0.0.0 -p 3000" --name monsta-frontend
              pm2 save
              pm2 status
              echo "âœ… Server restarted!"
EOF
          else
            echo "ğŸš¨ Emergency deployment mode: ${{ inputs.deployment_mode }}"
            ssh -i ~/.ssh/deploy_key ubuntu@15.165.105.250 << 'EOF'
              set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¤‘ë‹¨

              echo "ğŸš€ Starting emergency deployment..."

              # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬
              cd ~/monstas7 || { echo "âŒ Project not found"; exit 1; }

              # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (ê°•ì œ)
              echo "ğŸ“¥ Force pulling latest code..."
              git fetch --all
              git reset --hard origin/master

              # Frontend ë””ë ‰í† ë¦¬
              cd frontend

              # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
              echo "ğŸ§¹ Cleaning up processes..."
              pm2 delete all 2>/dev/null || true

              # ìºì‹œ ì™„ì „ ì •ë¦¬
              echo "ğŸ—‘ï¸ Deep cleaning cache..."
              rm -rf .next
              rm -rf node_modules/.cache
              rm -rf .npm

              # ì˜ì¡´ì„± ì¬ì„¤ì¹˜
              echo "ğŸ“¦ Reinstalling dependencies..."
              rm -rf node_modules package-lock.json
              npm cache clean --force
              npm install --legacy-peer-deps

              # react-is íŒ¨í‚¤ì§€ í™•ì¸
              npm list react-is || npm install react-is --save

              # ë°°í¬ ëª¨ë“œ ê²°ì •
              if [ "${{ inputs.deployment_mode }}" = "production" ]; then
                echo "ğŸ—ï¸ Attempting production build..."
                if npm run build; then
                  echo "âœ… Production build successful!"
                  pm2 start npm --name monsta-prod -- start -- -H 0.0.0.0 -p 3000
                else
                  echo "âš ï¸ Production build failed! Falling back to development..."
                  pm2 start "npx next dev -H 0.0.0.0 -p 3000" --name monsta-frontend
                fi
              else
                echo "ğŸ”§ Starting in development mode..."
                pm2 start "npx next dev -H 0.0.0.0 -p 3000" --name monsta-frontend
              fi

              # PM2 ì„¤ì • ì €ì¥
              pm2 save

              # ëŒ€ê¸°
              sleep 5

              # PM2 ìƒíƒœ
              echo "ğŸ“Š PM2 Status:"
              pm2 status

              # í—¬ìŠ¤ì²´í¬
              echo "ğŸ¥ Running health check..."
              for i in {1..15}; do
                if curl -f -s http://localhost:3000 > /dev/null; then
                  echo "âœ… Server is responding!"
                  echo "ğŸ‰ Emergency deployment successful!"
                  echo "ğŸŒ Server running at http://15.165.105.250:3000"

                  # í¬íŠ¸ í™•ì¸
                  netstat -tlpn 2>/dev/null | grep -q :3000 && echo "âœ… Port 3000 is listening!"
                  exit 0
                else
                  echo "â³ Waiting for server... ($i/15)"
                  sleep 3
                fi
              done

              echo "âŒ Server failed to start after 15 attempts!"
              echo "ğŸ“‹ PM2 Logs:"
              pm2 logs --lines 100
              exit 1
EOF
          fi