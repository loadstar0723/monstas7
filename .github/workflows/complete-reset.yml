name: Complete Server Reset

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - 'reset.trigger'

jobs:
  reset:
    runs-on: ubuntu-latest
    
    steps:
      - name: Complete Server Reset
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          timeout: 30m
          script: |
            echo "ðŸ”¥ ì™„ì „í•œ ì„œë²„ ë¦¬ì…‹ ì‹œìž‘..."
            
            # 1. ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
            echo "ëª¨ë“  Node í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ..."
            sudo killall -9 node 2>/dev/null || true
            sudo killall -9 npm 2>/dev/null || true
            pm2 kill 2>/dev/null || true
            
            # 2. í¬íŠ¸ ì •ë¦¬
            echo "í¬íŠ¸ 3000 ì •ë¦¬..."
            sudo fuser -k 3000/tcp 2>/dev/null || true
            
            # 3. ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°±ì—… ë° ìƒˆë¡œ í´ë¡ 
            echo "í”„ë¡œì íŠ¸ ìƒˆë¡œ í´ë¡ ..."
            cd ~
            rm -rf monstas7_old
            mv monstas7 monstas7_old 2>/dev/null || true
            git clone https://github.com/loadstar0723/monstas7.git
            
            # 4. í”„ë¡œì íŠ¸ ì„¤ì •
            cd ~/monstas7/frontend
            
            # 5. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            echo "í™˜ê²½ ë³€ìˆ˜ ì„¤ì •..."
            cat > .env.local << 'EOF'
            NEXTAUTH_SECRET=monstas7-secret-key-2024
            NEXTAUTH_URL=http://13.209.84.93:3000
            DATABASE_URL="file:./dev.db"
            NODE_ENV=production
            EOF
            
            # 6. Node.js ë²„ì „ í™•ì¸ ë° ì„¤ì •
            echo "Node.js ë²„ì „ í™•ì¸..."
            node -v
            npm -v
            
            # 7. ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ ì •ë¦¬)
            echo "ì˜ì¡´ì„± í´ë¦° ì„¤ì¹˜..."
            npm cache clean --force
            npm install --legacy-peer-deps
            
            # 8. Prisma ì„¤ì •
            echo "Prisma ì„¤ì •..."
            npx prisma generate
            npx prisma db push
            
            # 9. í”„ë¡œë•ì…˜ ë¹Œë“œ
            echo "í”„ë¡œë•ì…˜ ë¹Œë“œ ì‹œìž‘..."
            npm run build || {
              echo "ë¹Œë“œ ì‹¤íŒ¨, ê°œë°œ ëª¨ë“œë¡œ ì „í™˜..."
              NODE_ENV=development
            }
            
            # 10. PM2 ì„¤ì • íŒŒì¼ ìƒì„±
            echo "PM2 ì„¤ì • íŒŒì¼ ìƒì„±..."
            cat > ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'monsta-nextjs',
                script: 'npm',
                args: 'start',
                cwd: '/home/ubuntu/monstas7/frontend',
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: '1G',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000,
                  HOST: '0.0.0.0'
                }
              }]
            }
            EOF
            
            # 11. PM2ë¡œ ì‹œìž‘
            echo "PM2ë¡œ ì•± ì‹œìž‘..."
            pm2 start ecosystem.config.js
            pm2 save
            pm2 startup systemd -u ubuntu --hp /home/ubuntu
            
            # 12. ëŒ€ê¸°
            echo "ì„œë²„ ì‹œìž‘ ëŒ€ê¸°..."
            sleep 15
            
            # 13. ìƒíƒœ í™•ì¸
            echo "=== PM2 ìƒíƒœ ==="
            pm2 status
            
            echo "=== PM2 ë¡œê·¸ (ë§ˆì§€ë§‰ 50ì¤„) ==="
            pm2 logs --lines 50 --nostream
            
            echo "=== í¬íŠ¸ í™•ì¸ ==="
            sudo netstat -tlnp | grep :3000
            
            echo "=== í”„ë¡œì„¸ìŠ¤ í™•ì¸ ==="
            ps aux | grep node | grep -v grep
            
            # 14. í—¬ìŠ¤ ì²´í¬
            echo "=== í—¬ìŠ¤ ì²´í¬ ==="
            for i in {1..5}; do
              echo "ì‹œë„ $i/5..."
              curl -f http://localhost:3000 && echo "âœ… ì„œë²„ ì‹¤í–‰ ì¤‘!" && break
              sleep 3
            done
            
            # 15. ìµœì¢… í™•ì¸
            echo "=== ìµœì¢… ìƒíƒœ ==="
            curl -I http://localhost:3000 || echo "ì„œë²„ ì‘ë‹µ ì—†ìŒ"
            
            echo "âœ… ì™„ì „í•œ ì„œë²„ ë¦¬ì…‹ ì™„ë£Œ"
            echo "ðŸŒ ì ‘ì† ì£¼ì†Œ: http://13.209.84.93:3000"
            echo "ðŸ“Š ë¹„ì •ìƒ ì˜µì…˜: http://13.209.84.93:3000/signals/unusual-options"