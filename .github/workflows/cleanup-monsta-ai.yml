name: Clean Up monsta-ai-trading

on:
  workflow_dispatch:

jobs:
  cleanup-monsta-ai:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clean up monsta-ai-trading from AWS server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          script: |
            echo "ğŸ§¹ monsta-ai-trading ì •ë¦¬ ì‹œì‘..."
            
            # 1. í™ˆ ë””ë ‰í† ë¦¬ì—ì„œ ê´€ë ¨ í´ë” ì°¾ê¸°
            echo "ğŸ“ ê´€ë ¨ ë””ë ‰í† ë¦¬ ê²€ìƒ‰ ì¤‘..."
            find ~/ -maxdepth 3 -type d -name "*monsta-ai*" -o -name "*ai-trading*" 2>/dev/null | while read dir; do
                echo "ë°œê²¬: $dir"
            done
            
            # 2. PM2ì—ì„œ ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo ""
            echo "ğŸ”§ PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
            pm2 list | grep -E "monsta-ai|ai-trading" | awk '{print $4}' | while read app; do
                if [ ! -z "$app" ] && [ "$app" != "name" ]; then
                    echo "PM2 í”„ë¡œì„¸ìŠ¤ ì‚­ì œ: $app"
                    pm2 delete "$app" 2>/dev/null || true
                fi
            done
            
            # 3. ë””ë ‰í† ë¦¬ ì‚­ì œ
            echo ""
            echo "ğŸ—‘ï¸ ë””ë ‰í† ë¦¬ ì‚­ì œ ì¤‘..."
            
            # ëª…ì‹œì ìœ¼ë¡œ ì‚­ì œí•  ë””ë ‰í† ë¦¬ë“¤
            DIRS_TO_DELETE=(
                ~/monsta-ai-trading
                ~/monsta-ai
                ~/ai-trading
                ~/projects/monsta-ai-trading
                ~/workspace/monsta-ai-trading
            )
            
            for dir in "${DIRS_TO_DELETE[@]}"; do
                if [ -d "$dir" ]; then
                    echo "ì‚­ì œ: $dir"
                    rm -rf "$dir"
                fi
            done
            
            # 4. Docker ì»¨í…Œì´ë„ˆ/ì´ë¯¸ì§€ ì •ë¦¬ (ìˆë‹¤ë©´)
            echo ""
            echo "ğŸ³ Docker ì •ë¦¬..."
            docker ps -a | grep -E "monsta-ai|ai-trading" | awk '{print $1}' | while read container; do
                if [ ! -z "$container" ]; then
                    echo "Docker ì»¨í…Œì´ë„ˆ ì‚­ì œ: $container"
                    docker rm -f "$container" 2>/dev/null || true
                fi
            done
            
            docker images | grep -E "monsta-ai|ai-trading" | awk '{print $3}' | while read image; do
                if [ ! -z "$image" ]; then
                    echo "Docker ì´ë¯¸ì§€ ì‚­ì œ: $image"
                    docker rmi -f "$image" 2>/dev/null || true
                fi
            done
            
            # 5. ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤ í™•ì¸ (systemd)
            echo ""
            echo "âš™ï¸ ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤ í™•ì¸..."
            sudo systemctl list-units --all | grep -E "monsta-ai|ai-trading" | awk '{print $1}' | while read service; do
                if [ ! -z "$service" ]; then
                    echo "ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ë¹„í™œì„±í™”: $service"
                    sudo systemctl stop "$service" 2>/dev/null || true
                    sudo systemctl disable "$service" 2>/dev/null || true
                fi
            done
            
            # 6. nginx ì„¤ì • ì •ë¦¬
            echo ""
            echo "ğŸŒ Nginx ì„¤ì • ì •ë¦¬..."
            if [ -f /etc/nginx/sites-enabled/monsta-ai-trading ]; then
                sudo rm /etc/nginx/sites-enabled/monsta-ai-trading
                sudo rm /etc/nginx/sites-available/monsta-ai-trading 2>/dev/null || true
                sudo nginx -s reload
                echo "Nginx ì„¤ì • ì‚­ì œë¨"
            fi
            
            # 7. ìµœì¢… í™•ì¸
            echo ""
            echo "ğŸ“Š ì •ë¦¬ í›„ í™•ì¸:"
            echo "ë‚¨ì€ ë””ë ‰í† ë¦¬:"
            ls -la ~/ | grep -E "monsta|trading" || echo "  ê´€ë ¨ ë””ë ‰í† ë¦¬ ì—†ìŒ"
            
            echo ""
            echo "PM2 í”„ë¡œì„¸ìŠ¤:"
            pm2 list | grep -E "monsta|trading" || echo "  ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            echo ""
            echo "âœ… monsta-ai-trading ì •ë¦¬ ì™„ë£Œ!"
            
      - name: Send cleanup notification
        uses: appleboy/telegram-action@master
        if: always()
        with:
          to: ${{ secrets.DEPLOY_TELEGRAM_CHAT_ID }}
          token: ${{ secrets.DEPLOY_TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸ§¹ monsta-ai-trading ì •ë¦¬ ì™„ë£Œ
            
            ğŸ“ ì‘ì—…: monsta-ai-trading ì™„ì „ ì‚­ì œ
            ğŸ—‘ï¸ GitHub ë ˆí¬ì§€í† ë¦¬ & AWS ì„œë²„ ì •ë¦¬
            ğŸ‘¤ ì‹¤í–‰ì: ${{ github.actor }}
            
            âœ… ì •ë¦¬ í•­ëª©:
            - AWS ì„œë²„ ë””ë ‰í† ë¦¬
            - PM2 í”„ë¡œì„¸ìŠ¤
            - Docker ì»¨í…Œì´ë„ˆ/ì´ë¯¸ì§€
            - Nginx ì„¤ì •