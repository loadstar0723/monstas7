name: Health Check

on:
  schedule:
    # ë§¤ 30ë¶„ë§ˆë‹¤ ì‹¤í–‰
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Check Server Health
        run: |
          echo "ðŸ¥ Checking server health..."

          # HTTP ìƒíƒœ ì½”ë“œ í™•ì¸
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://15.165.105.250:3000)

          if [ "$STATUS_CODE" = "200" ]; then
            echo "âœ… Server is healthy! (Status: $STATUS_CODE)"
          else
            echo "âŒ Server is not responding! (Status: $STATUS_CODE)"
            exit 1
          fi

          # ì‘ë‹µ ì‹œê°„ ì²´í¬
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" http://15.165.105.250:3000)
          echo "â±ï¸ Response time: ${RESPONSE_TIME}s"

          # ì‘ë‹µ ì‹œê°„ì´ 10ì´ˆ ì´ìƒì´ë©´ ê²½ê³ 
          if (( $(echo "$RESPONSE_TIME > 10" | bc -l) )); then
            echo "âš ï¸ Warning: Server response is slow!"
          fi

      - name: Restart if Down
        if: failure()
        env:
          DEPLOY_KEY: ${{ secrets.AWS_SERVER_KEY }}
        run: |
          echo "ðŸ”„ Attempting to restart server..."

          # SSH í‚¤ ì„¤ì •
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 15.165.105.250 >> ~/.ssh/known_hosts

          # ì„œë²„ ìž¬ì‹œìž‘
          ssh -i ~/.ssh/deploy_key ubuntu@15.165.105.250 << 'EOF'
            cd ~/monstas7/frontend

            # PM2 í”„ë¡œì„¸ìŠ¤ ìž¬ì‹œìž‘
            pm2 restart all || {
              # ìž¬ì‹œìž‘ ì‹¤íŒ¨ ì‹œ ì™„ì „ ìž¬ë°°í¬
              pm2 delete all
              pm2 start "npx next dev -H 0.0.0.0 -p 3000" --name monsta-frontend
              pm2 save
            }

            pm2 list
          EOF