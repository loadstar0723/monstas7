name: Direct SSH Server Fix

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/direct-ssh-fix.yml'

jobs:
  direct-fix:
    runs-on: ubuntu-latest
    
    steps:
      - name: Direct SSH Commands to Fix Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          timeout: 30m
          script: |
            set -e
            echo "ğŸ”§ ì„œë²„ ì§ì ‘ ë³µêµ¬ ì‹œì‘ $(date)"
            
            # 1ë‹¨ê³„: ê°•ì œ ì •ë¦¬
            echo "====== 1. ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ ======"
            pm2 kill || echo "PM2 ì¢…ë£Œ ì‹¤íŒ¨"
            sudo killall -9 node || echo "node í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            sudo killall -9 npm || echo "npm í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            sudo fuser -k 3000/tcp || echo "í¬íŠ¸ 3000 ì´ë¯¸ í•´ì œë¨"
            
            # 2ë‹¨ê³„: ë””ë ‰í† ë¦¬ í™•ì¸
            echo "====== 2. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ ======"
            if [ -d ~/monstas7 ]; then
                echo "monstas7 ë””ë ‰í† ë¦¬ ë°œê²¬"
                cd ~/monstas7
            else
                echo "monstas7 ë””ë ‰í† ë¦¬ ì—†ìŒ, í´ë¡  ì‹œì‘"
                cd ~
                git clone https://github.com/loadstar0723/monstas7.git
                cd monstas7
            fi
            
            # 3ë‹¨ê³„: ìµœì‹  ì½”ë“œ
            echo "====== 3. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° ======"
            git fetch origin
            git reset --hard origin/master
            git pull origin master
            
            # 4ë‹¨ê³„: Frontend ë””ë ‰í† ë¦¬
            echo "====== 4. Frontend ë””ë ‰í† ë¦¬ ì´ë™ ======"
            cd frontend
            pwd
            ls -la
            
            # 5ë‹¨ê³„: í´ë¦° ì„¤ì¹˜
            echo "====== 5. ì˜ì¡´ì„± í´ë¦° ì„¤ì¹˜ ======"
            rm -rf node_modules package-lock.json .next
            npm cache clean --force
            
            # í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
            npm install --save tailwindcss@latest autoprefixer@latest postcss@latest
            
            # ì „ì²´ ì„¤ì¹˜
            npm install
            
            # 6ë‹¨ê³„: í™˜ê²½ ì„¤ì •
            echo "====== 6. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ======"
            cat > .env.local << 'ENVEOF'
            NEXTAUTH_SECRET=monstas7-secret-key-2024-production-secure
            NEXTAUTH_URL=http://13.209.84.93:3000
            NODE_ENV=production
            DATABASE_URL="file:./prisma/dev.db"
            NEXT_PUBLIC_API_URL=http://13.209.84.93:3000/api
            ENVEOF
            
            cp .env.local .env.production
            cp .env.local .env
            
            # 7ë‹¨ê³„: Prisma
            echo "====== 7. Prisma ìƒì„± ======"
            npx prisma generate || echo "Prisma ìƒì„± ì‹¤íŒ¨"
            
            # 8ë‹¨ê³„: PM2 ì •ë¦¬
            echo "====== 8. PM2 ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ======"
            pm2 delete all || echo "ì‚­ì œí•  í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            # 9ë‹¨ê³„: ì„œë²„ ì‹œì‘ (ì—¬ëŸ¬ ë°©ë²• ì‹œë„)
            echo "====== 9. ì„œë²„ ì‹œì‘ ======"
            
            # ë°©ë²• 1: PM2 ê°œë°œ ëª¨ë“œ
            echo "ë°©ë²• 1: PM2 ê°œë°œ ëª¨ë“œ ì‹œë„..."
            PORT=3000 HOST=0.0.0.0 NODE_OPTIONS="--max-old-space-size=512" \
            pm2 start npm --name monsta-prod -- run dev
            
            # PM2 ì €ì¥
            pm2 save
            pm2 startup systemd -u ubuntu --hp /home/ubuntu || echo "startup ì„¤ì • ì‹¤íŒ¨"
            
            # 10ë‹¨ê³„: í™•ì¸
            echo "====== 10. ìƒíƒœ í™•ì¸ ======"
            sleep 5
            
            # PM2 ìƒíƒœ
            echo "PM2 í”„ë¡œì„¸ìŠ¤:"
            pm2 list
            
            # í¬íŠ¸ í™•ì¸
            echo "í¬íŠ¸ 3000 ìƒíƒœ:"
            sudo netstat -tlnp | grep :3000 || echo "í¬íŠ¸ 3000 ë¦¬ìŠ¤ë‹ ì•ˆë¨"
            
            # í”„ë¡œì„¸ìŠ¤ í™•ì¸
            echo "Node í”„ë¡œì„¸ìŠ¤:"
            ps aux | grep node | head -5
            
            # 11ë‹¨ê³„: ë¡œê·¸
            echo "====== 11. ë¡œê·¸ í™•ì¸ ======"
            pm2 logs monsta-prod --lines 30 --nostream || echo "ë¡œê·¸ ì—†ìŒ"
            
            # 12ë‹¨ê³„: í…ŒìŠ¤íŠ¸
            echo "====== 12. ì ‘ì† í…ŒìŠ¤íŠ¸ ======"
            sleep 5
            
            # localhost í…ŒìŠ¤íŠ¸
            if curl -f -m 10 http://localhost:3000 > /dev/null 2>&1; then
                echo "âœ… localhost:3000 ì‘ë‹µ ì„±ê³µ!"
            else
                echo "âŒ localhost:3000 ì‘ë‹µ ì‹¤íŒ¨"
                
                # ë°±ì—… ë°©ë²•: nohup
                echo "ë°±ì—… ë°©ë²•: nohupìœ¼ë¡œ ì§ì ‘ ì‹¤í–‰..."
                pm2 delete monsta-prod || true
                cd ~/monstas7/frontend
                PORT=3000 HOST=0.0.0.0 nohup npm run dev > ~/server.log 2>&1 &
                echo "PID: $!"
                sleep 5
                echo "ì„œë²„ ë¡œê·¸:"
                tail -30 ~/server.log
            fi
            
            # 13ë‹¨ê³„: ìµœì¢… ë©”ì‹œì§€
            echo "====== 13. ìµœì¢… ìƒíƒœ ======"
            echo "ë©”ëª¨ë¦¬:"
            free -h
            echo ""
            echo "ë””ìŠ¤í¬:"
            df -h | grep -E "/$|/home"
            echo ""
            echo "âœ… ë³µêµ¬ ì‹œë„ ì™„ë£Œ!"
            echo "ğŸŒ ì ‘ì† ì£¼ì†Œ: http://13.209.84.93:3000"
            echo "ğŸ“ PM2 ëª¨ë‹ˆí„°: pm2 monit"
            echo "ğŸ”„ ì¬ì‹œì‘: pm2 restart monsta-prod"
            echo "ğŸ“‹ ë¡œê·¸: pm2 logs monsta-prod"