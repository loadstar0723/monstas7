name: Clean Up Old Projects

on:
  workflow_dispatch:
    inputs:
      backup:
        description: 'Create backup before deletion'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  cleanup-aws-server:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clean up old projects on AWS server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          script: |
            echo "ğŸ§¹ ì„œë²„ ì •ë¦¬ ì‹œì‘..."
            
            # í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì íŠ¸ ê²½ë¡œ
            CURRENT_PROJECT="~/monsta-v7/monstas7"
            
            # ë°±ì—… ì˜µì…˜
            BACKUP_OPTION="${{ github.event.inputs.backup }}"
            
            # 1. í˜„ì¬ í”„ë¡œì íŠ¸ í™•ì¸
            echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬ ìƒíƒœ:"
            ls -la ~/ | head -20
            
            # 2. ê¸°ì¡´ monsta ê´€ë ¨ ë””ë ‰í† ë¦¬ ì°¾ê¸° (í˜„ì¬ í”„ë¡œì íŠ¸ ì œì™¸)
            echo ""
            echo "ğŸ” ì‚­ì œí•  í”„ë¡œì íŠ¸ ê²€ìƒ‰ ì¤‘..."
            OLD_DIRS=$(find ~/ -maxdepth 2 -type d -name "*monsta*" -o -name "*streamlit*" -o -name "*test*" 2>/dev/null | grep -v "monsta-v7/monstas7" || true)
            
            # ë°±ì—… ìƒì„± (ì˜µì…˜)
            if [ "$BACKUP_OPTION" = "true" ] && [ ! -z "$OLD_DIRS" ]; then
                echo "ğŸ’¾ ë°±ì—… ìƒì„± ì¤‘..."
                BACKUP_DIR=~/backups/cleanup_$(date +%Y%m%d_%H%M%S)
                mkdir -p $BACKUP_DIR
                
                for dir in $OLD_DIRS; do
                    if [ -d "$dir" ]; then
                        dir_name=$(basename "$dir")
                        echo "ë°±ì—…: $dir_name"
                        tar -czf "$BACKUP_DIR/${dir_name}.tar.gz" "$dir" 2>/dev/null || true
                    fi
                done
                echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_DIR"
            fi
            
            # 3. ê¸°ì¡´ í”„ë¡œì íŠ¸ ì‚­ì œ
            echo ""
            echo "ğŸ—‘ï¸ ê¸°ì¡´ í”„ë¡œì íŠ¸ ì‚­ì œ ì¤‘..."
            
            # ëª…ì‹œì ìœ¼ë¡œ ì‚­ì œí•  ë””ë ‰í† ë¦¬ë“¤
            DIRS_TO_DELETE=(
                ~/monsta
                ~/monsta-old
                ~/monsta-test
                ~/monsta-project
                ~/streamlit-app
                ~/test-monsta
                ~/monsta-backup
                ~/monsta-v1
                ~/monsta-v2
                ~/monsta-v3
                ~/monsta-v4
                ~/monsta-v5
                ~/monsta-v6
            )
            
            for dir in "${DIRS_TO_DELETE[@]}"; do
                if [ -d "$dir" ] && [ "$dir" != "$CURRENT_PROJECT" ]; then
                    echo "ì‚­ì œ: $dir"
                    rm -rf "$dir"
                fi
            done
            
            # ì¶”ê°€ë¡œ ë°œê²¬ëœ ë””ë ‰í† ë¦¬ ì‚­ì œ
            for dir in $OLD_DIRS; do
                if [ -d "$dir" ] && [ "$dir" != "$CURRENT_PROJECT" ]; then
                    echo "ì‚­ì œ: $dir"
                    rm -rf "$dir"
                fi
            done
            
            # 4. PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ (í˜„ì¬ í”„ë¡œì„¸ìŠ¤ ìœ ì§€)
            echo ""
            echo "ğŸ”§ PM2 ì •ë¦¬..."
            pm2 list
            
            # monsta-nextjs ì œì™¸í•˜ê³  ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ ì‚­ì œ
            pm2 list | grep -v "monsta-nextjs" | grep "â”‚" | awk '{print $4}' | while read app; do
                if [ ! -z "$app" ] && [ "$app" != "name" ] && [ "$app" != "monsta-nextjs" ]; then
                    pm2 delete "$app" 2>/dev/null || true
                fi
            done
            
            pm2 save --force
            
            # 5. ë¶ˆí•„ìš”í•œ Python ê°€ìƒí™˜ê²½ ì‚­ì œ
            echo ""
            echo "ğŸ Python ê°€ìƒí™˜ê²½ ì •ë¦¬..."
            find ~/ -maxdepth 3 -name "venv" -type d | grep -v "monsta-v7" | while read venv; do
                echo "ì‚­ì œ: $venv"
                rm -rf "$venv"
            done
            
            # 6. ì‹œìŠ¤í…œ ìºì‹œ ì •ë¦¬
            echo ""
            echo "ğŸ§¹ ìºì‹œ ì •ë¦¬..."
            npm cache clean --force 2>/dev/null || true
            pip cache purge 2>/dev/null || true
            
            # 7. ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
            echo ""
            echo "ğŸ’¾ ì •ë¦¬ í›„ ë””ìŠ¤í¬ ìƒíƒœ:"
            df -h /
            echo ""
            echo "í™ˆ ë””ë ‰í† ë¦¬ í¬ê¸°:"
            du -sh ~/
            echo ""
            echo "ë‚¨ì€ ë””ë ‰í† ë¦¬:"
            ls -la ~/ | grep "^d" | tail -n +2
            
            echo ""
            echo "âœ… ì„œë²„ ì •ë¦¬ ì™„ë£Œ!"
            echo "ğŸ“Œ í˜„ì¬ í™œì„± í”„ë¡œì íŠ¸: $CURRENT_PROJECT"
            
      - name: Send cleanup notification
        uses: appleboy/telegram-action@master
        if: always()
        with:
          to: ${{ secrets.DEPLOY_TELEGRAM_CHAT_ID }}
          token: ${{ secrets.DEPLOY_TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸ§¹ AWS ì„œë²„ ì •ë¦¬ ì™„ë£Œ
            
            ğŸ“ ì‘ì—…: ê¸°ì¡´ í”„ë¡œì íŠ¸ ì‚­ì œ
            ğŸ’¾ ë°±ì—…: ${{ github.event.inputs.backup }}
            ğŸ‘¤ ì‹¤í–‰ì: ${{ github.actor }}
            
            âœ… í˜„ì¬ í”„ë¡œì íŠ¸ë§Œ ìœ ì§€ë¨:
            - ~/monsta-v7/monstas7