name: Simple Restart

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  restart:
    runs-on: ubuntu-latest
    
    steps:
      - name: Simple Server Restart
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          timeout: 30m
          script: |
            echo "ğŸ”„ ê°„ë‹¨í•œ ì„œë²„ ì¬ì‹œì‘..."
            
            # 1. ëª¨ë“  ê²ƒ ì •ë¦¬
            pm2 kill
            killall -9 node npm 2>/dev/null || true
            
            # 2. ë””ë ‰í† ë¦¬ ì´ë™
            cd ~/monstas7/frontend || {
              cd ~
              git clone https://github.com/loadstar0723/monstas7.git
              cd monstas7/frontend
            }
            
            # 3. ìµœì‹  ì½”ë“œ
            git pull origin master
            
            # 4. íŒ¨í‚¤ì§€ ì„¤ì¹˜
            npm install
            
            # 5. ê°œë°œ ëª¨ë“œë¡œ ë°”ë¡œ ì‹¤í–‰
            PORT=3000 nohup npm run dev > server.log 2>&1 &
            
            # 6. í™•ì¸
            sleep 10
            echo "ì„œë²„ PID: $(pgrep -f 'npm run dev')"
            echo "í¬íŠ¸ í™•ì¸:"
            netstat -tlnp | grep 3000
            echo "ë¡œê·¸:"
            tail -20 server.log
            
            echo "âœ… ì™„ë£Œ: http://13.209.84.93:3000"