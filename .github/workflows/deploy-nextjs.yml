name: Deploy Next.js Frontend

on:
  push:
    branches: [ main, master ]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-nextjs.yml'
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy Frontend to AWS
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          script: |
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/monsta-v7/monstas7
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git pull origin master
            
            # Frontend ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd frontend
            
            # Node.js í™˜ê²½ ì„¤ì • (nvmì´ ìˆë‹¤ë©´)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            npm install
            
            # ê¸°ì¡´ PM2 í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€
            pm2 stop monsta-frontend || true
            pm2 delete monsta-frontend || true
            
            # í”„ë¡œë•ì…˜ ë¹Œë“œ
            npm run build
            
            # PM2ë¡œ ì‹¤í–‰ (í¬íŠ¸ 3001)
            pm2 start npm --name "monsta-frontend" -- start -- -p 3001
            
            # PM2 ì„¤ì • ì €ì¥
            pm2 save
            pm2 startup || true
            
            # í—¬ìŠ¤ ì²´í¬ (20ì´ˆ ëŒ€ê¸°)
            sleep 20
            
            # í”„ë¡œì„¸ìŠ¤ í™•ì¸
            if pm2 list | grep -q "monsta-frontend.*online"; then
              echo "âœ… Frontend is running"
              echo "ğŸŒ Access: http://13.209.84.93:3001"
            else
              echo "âŒ Frontend failed to start"
              pm2 logs monsta-frontend --lines 50
              exit 1
            fi