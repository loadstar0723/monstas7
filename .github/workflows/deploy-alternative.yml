name: Deploy with Alternative Port

on:
  workflow_dispatch:
    inputs:
      port:
        description: 'Port number to deploy on'
        required: false
        default: '8509'
        type: string

jobs:
  deploy-alternative:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Alternative Port
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          script: |
            PORT=${{ github.event.inputs.port }}
            echo "Deploying on port $PORT"
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/monsta-v7/monstas7
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git pull origin master
            
            # ê°€ìƒí™˜ê²½ í™œì„±í™”
            source venv/bin/activate
            
            # í•´ë‹¹ í¬íŠ¸ì˜ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            sudo lsof -ti:$PORT | xargs -r sudo kill -9 || true
            
            # Streamlit ì‹¤í–‰ (ë‹¤ë¥¸ í¬íŠ¸)
            nohup streamlit run app.py --server.port=$PORT --server.address=0.0.0.0 > app_$PORT.log 2>&1 &
            
            sleep 10
            
            # í—¬ìŠ¤ ì²´í¬
            if curl -f http://localhost:$PORT > /dev/null 2>&1; then
              echo "âœ… Successfully deployed on port $PORT"
              echo "ğŸŒ Access: http://13.209.84.93:$PORT"
            else
              echo "âŒ Deployment failed on port $PORT"
              tail -n 30 app_$PORT.log
              exit 1
            fi