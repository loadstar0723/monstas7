name: ðŸš¨ Emergency Server Recovery

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Recovery action'
        required: true
        default: 'restart'
        type: choice
        options:
          - restart
          - full-recovery
          - check-status

jobs:
  server-recovery:
    runs-on: ubuntu-latest

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2

    - name: Check Instance Status
      id: check
      run: |
        INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"

        # ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ í™•ì¸
        STATE=$(aws ec2 describe-instances \
          --instance-ids $INSTANCE_ID \
          --query 'Reservations[0].Instances[0].State.Name' \
          --output text)

        echo "Instance state: $STATE"
        echo "state=$STATE" >> $GITHUB_OUTPUT

        # ì¸ìŠ¤í„´ìŠ¤ ì •ë³´ ì¶œë ¥
        aws ec2 describe-instances \
          --instance-ids $INSTANCE_ID \
          --query 'Reservations[0].Instances[0].{ID:InstanceId,Type:InstanceType,State:State.Name,IP:PublicIpAddress}'

    - name: Start Instance if Stopped
      if: steps.check.outputs.state == 'stopped'
      run: |
        echo "ðŸ”´ Instance is stopped. Starting..."
        aws ec2 start-instances --instance-ids ${{ secrets.EC2_INSTANCE_ID }}

        # ì¸ìŠ¤í„´ìŠ¤ ì‹œìž‘ ëŒ€ê¸° (ìµœëŒ€ 5ë¶„)
        aws ec2 wait instance-running \
          --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
          --no-cli-pager || true

        echo "âœ… Instance started successfully"

        # IP ì£¼ì†Œ í™•ì¸
        aws ec2 describe-instances \
          --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text

    - name: Reboot Instance if Running
      if: steps.check.outputs.state == 'running' && github.event.inputs.action == 'restart'
      run: |
        echo "ðŸ”„ Rebooting instance..."
        aws ec2 reboot-instances --instance-ids ${{ secrets.EC2_INSTANCE_ID }}
        sleep 60
        echo "âœ… Instance rebooted"

    - name: Wait for SSH
      if: github.event.inputs.action != 'check-status'
      run: |
        echo "â³ Waiting for SSH to be available..."
        for i in {1..30}; do
          if nc -zv ${{ secrets.EC2_HOST }} 22 2>/dev/null; then
            echo "âœ… SSH is available"
            break
          fi
          echo "Attempt $i/30: SSH not ready, waiting..."
          sleep 10
        done

    - name: Deploy and Start Services
      if: github.event.inputs.action != 'check-status'
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_KEY }}
        script: |
          echo "ðŸš€ Starting server recovery..."

          # ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸
          echo "ðŸ“Š System Information:"
          free -h
          df -h

          # ë©”ëª¨ë¦¬ ì •ë¦¬
          sudo sync
          echo 3 | sudo tee /proc/sys/vm/drop_caches

          # ìŠ¤ì™‘ ë©”ëª¨ë¦¬ í™•ì¸/ìƒì„±
          if [ ! -f /swapfile ]; then
            echo "ðŸ“¦ Creating swap file..."
            sudo fallocate -l 2G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
          fi

          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          echo "ðŸ§¹ Cleaning old processes..."
          sudo pkill -f node || true
          sudo pkill -f npm || true
          pm2 delete all || true

          # Git ì—…ë°ì´íŠ¸
          cd /home/ubuntu/monstas7
          git fetch origin
          git reset --hard origin/master

          # Frontend ì‹œìž‘ (ê°€ë²¼ìš´ ëª¨ë“œ)
          cd frontend

          # .env íŒŒì¼ ìƒì„±
          cat > .env.local << 'EOF'
          NEXT_PUBLIC_API_URL=http://15.165.105.250:8000
          NODE_ENV=production
          EOF

          # PM2 ecosystem ì„¤ì •
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'monstas-frontend',
              script: 'node_modules/.bin/next',
              args: 'start -p 3000',
              instances: 1,
              exec_mode: 'fork',
              max_memory_restart: '400M',
              env: {
                PORT: 3000,
                NODE_ENV: 'production',
                NODE_OPTIONS: '--max-old-space-size=512'
              },
              error_file: '/home/ubuntu/logs/frontend-error.log',
              out_file: '/home/ubuntu/logs/frontend-out.log',
              merge_logs: true,
              time: true
            }]
          }
          EOF

          # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p /home/ubuntu/logs

          # Production ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜
          echo "ðŸ“¦ Installing production dependencies..."
          npm ci --production --silent

          # ë¹Œë“œ íŒŒì¼ í™•ì¸
          if [ ! -d ".next" ]; then
            echo "ðŸ”¨ Building application..."
            NODE_OPTIONS="--max-old-space-size=512" npm run build
          fi

          # PM2 ì‹œìž‘
          echo "ðŸš€ Starting application with PM2..."
          pm2 start ecosystem.config.js
          pm2 save
          pm2 startup systemd -u ubuntu --hp /home/ubuntu

          # Nginx ì„¤ì • í™•ì¸
          sudo nginx -t
          sudo systemctl restart nginx

          # ìƒíƒœ í™•ì¸
          echo "âœ… Services Status:"
          pm2 list
          pm2 monit --lines 10

          # í¬íŠ¸ í™•ì¸
          echo "ðŸ” Port Status:"
          sudo netstat -tlpn | grep -E ":(3000|80|443)"

          # ìµœì¢… í™•ì¸
          curl -I http://localhost:3000 || echo "Frontend not responding"

          echo "âœ¨ Server recovery completed!"
          echo "ðŸŒ Access URL: http://15.165.105.250"