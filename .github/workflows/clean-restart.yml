name: Clean Restart Fix

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  clean-restart:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clean Restart Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          timeout: 30m
          script: |
            echo "🧹 서버 클린 재시작 시작..."
            echo "================================"
            
            # 1. 모든 프로세스 종료
            echo "1️⃣ 모든 Node/PM2 프로세스 종료..."
            pm2 kill 2>/dev/null || true
            killall -9 node 2>/dev/null || true
            killall -9 npm 2>/dev/null || true
            
            # 2. 포트 해제
            echo "2️⃣ 포트 3000 강제 해제..."
            sudo fuser -k 3000/tcp 2>/dev/null || true
            
            # 3. 프로젝트 디렉토리 이동
            echo "3️⃣ 프로젝트 디렉토리 확인..."
            cd ~/monstas7/frontend || {
              echo "프로젝트 디렉토리 없음, 클론 시작..."
              cd ~
              git clone https://github.com/loadstar0723/monstas7.git
              cd monstas7/frontend
            }
            
            # 4. Git 최신 코드
            echo "4️⃣ 최신 코드 가져오기..."
            git fetch origin
            git reset --hard origin/master
            
            # 5. .next 폴더 완전 삭제
            echo "5️⃣ .next 폴더 완전 삭제..."
            rm -rf .next
            rm -rf .next.bak 2>/dev/null || true
            
            # 6. node_modules 재설치
            echo "6️⃣ 클린 설치 시작..."
            rm -rf node_modules package-lock.json
            npm cache clean --force
            
            # 7. 패키지 설치
            echo "7️⃣ 패키지 설치..."
            npm install
            
            # 8. 환경 변수 설정
            echo "8️⃣ 환경 변수 설정..."
            cat > .env.local << 'EOF'
            NEXTAUTH_SECRET=monstas7-secret-key-2024-production-secure
            NEXTAUTH_URL=http://13.209.84.93:3000
            NODE_ENV=development
            DATABASE_URL="file:./prisma/dev.db"
            EOF
            
            cp .env.local .env
            
            # 9. Prisma 생성
            echo "9️⃣ Prisma 클라이언트 생성..."
            npx prisma generate || echo "Prisma 생성 실패"
            
            # 10. 개발 모드로 시작 (빌드 없이)
            echo "🚀 개발 모드로 서버 시작..."
            PORT=3000 HOST=0.0.0.0 NODE_ENV=development nohup npm run dev > ~/server.log 2>&1 &
            SERVER_PID=$!
            echo "서버 PID: $SERVER_PID"
            
            # 11. 서버 시작 대기
            echo "⏳ 서버 시작 대기 (30초)..."
            sleep 30
            
            # 12. 프로세스 확인
            echo "📊 프로세스 상태:"
            ps aux | grep -E "node|npm" | grep -v grep | head -5
            
            # 13. 포트 확인
            echo "🔍 포트 3000 상태:"
            sudo netstat -tlnp | grep :3000 || echo "포트 3000 리스닝 안됨"
            
            # 14. 로그 확인
            echo "📝 서버 로그 (최근 50줄):"
            tail -50 ~/server.log
            
            # 15. 접속 테스트
            echo "🔍 서버 응답 테스트..."
            if curl -f -m 10 http://localhost:3000 > /dev/null 2>&1; then
              echo "✅ 서버가 정상 작동 중!"
              echo "🌐 접속 주소: http://13.209.84.93:3000"
            else
              echo "⚠️ 서버 응답 없음, PM2로 재시도..."
              
              # PM2로 재시도
              kill $SERVER_PID 2>/dev/null || true
              pm2 delete all 2>/dev/null || true
              
              # PM2 설정
              cat > ecosystem.config.js << 'PMEOF'
            module.exports = {
              apps: [{
                name: 'monsta-dev',
                script: 'npm',
                args: 'run dev',
                cwd: '/home/ubuntu/monstas7/frontend',
                instances: 1,
                exec_mode: 'fork',
                autorestart: true,
                watch: false,
                max_memory_restart: '500M',
                env: {
                  NODE_ENV: 'development',
                  PORT: 3000,
                  HOST: '0.0.0.0'
                }
              }]
            }
            PMEOF
              
              pm2 start ecosystem.config.js
              pm2 save
              
              sleep 10
              pm2 status
              pm2 logs monsta-dev --lines 30 --nostream
            fi
            
            # 16. 메모리 상태
            echo "💾 메모리 상태:"
            free -h
            
            # 17. 최종 메시지
            echo ""
            echo "✅ 클린 재시작 완료!"
            echo "🌐 접속 URL: http://13.209.84.93:3000"
            echo "📝 로그 위치: ~/server.log"
            echo "🔄 재시작: kill \$(pgrep -f 'npm run dev') && PORT=3000 npm run dev &"