name: Clean Restart Fix

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  clean-restart:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clean Restart Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          timeout: 30m
          script: |
            echo "ðŸ§¹ ì„œë²„ í´ë¦° ìž¬ì‹œìž‘ ì‹œìž‘..."
            echo "================================"
            
            # 1. ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            echo "1ï¸âƒ£ ëª¨ë“  Node/PM2 í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ..."
            pm2 kill 2>/dev/null || true
            killall -9 node 2>/dev/null || true
            killall -9 npm 2>/dev/null || true
            
            # 2. í¬íŠ¸ í•´ì œ
            echo "2ï¸âƒ£ í¬íŠ¸ 3000 ê°•ì œ í•´ì œ..."
            sudo fuser -k 3000/tcp 2>/dev/null || true
            
            # 3. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì´ë™
            echo "3ï¸âƒ£ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸..."
            cd ~/monstas7/frontend || {
              echo "í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì—†ìŒ, í´ë¡  ì‹œìž‘..."
              cd ~
              git clone https://github.com/loadstar0723/monstas7.git
              cd monstas7/frontend
            }
            
            # 4. Git ìµœì‹  ì½”ë“œ
            echo "4ï¸âƒ£ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
            git fetch origin
            git reset --hard origin/master
            
            # 5. .next í´ë” ì™„ì „ ì‚­ì œ
            echo "5ï¸âƒ£ .next í´ë” ì™„ì „ ì‚­ì œ..."
            rm -rf .next
            rm -rf .next.bak 2>/dev/null || true
            
            # 6. node_modules ìž¬ì„¤ì¹˜
            echo "6ï¸âƒ£ í´ë¦° ì„¤ì¹˜ ì‹œìž‘..."
            rm -rf node_modules package-lock.json
            npm cache clean --force
            
            # 7. íŒ¨í‚¤ì§€ ì„¤ì¹˜
            echo "7ï¸âƒ£ íŒ¨í‚¤ì§€ ì„¤ì¹˜..."
            npm install
            
            # 8. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            echo "8ï¸âƒ£ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •..."
            cat > .env.local << 'EOF'
            NEXTAUTH_SECRET=monstas7-secret-key-2024-production-secure
            NEXTAUTH_URL=http://13.209.84.93:3000
            NODE_ENV=development
            DATABASE_URL="file:./prisma/dev.db"
            EOF
            
            cp .env.local .env
            
            # 9. Prisma ìƒì„±
            echo "9ï¸âƒ£ Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„±..."
            npx prisma generate || echo "Prisma ìƒì„± ì‹¤íŒ¨"
            
            # 10. ê°œë°œ ëª¨ë“œë¡œ ì‹œìž‘ (ë¹Œë“œ ì—†ì´)
            echo "ðŸš€ ê°œë°œ ëª¨ë“œë¡œ ì„œë²„ ì‹œìž‘..."
            PORT=3000 HOST=0.0.0.0 NODE_ENV=development nohup npm run dev > ~/server.log 2>&1 &
            SERVER_PID=$!
            echo "ì„œë²„ PID: $SERVER_PID"
            
            # 11. ì„œë²„ ì‹œìž‘ ëŒ€ê¸°
            echo "â³ ì„œë²„ ì‹œìž‘ ëŒ€ê¸° (30ì´ˆ)..."
            sleep 30
            
            # 12. í”„ë¡œì„¸ìŠ¤ í™•ì¸
            echo "ðŸ“Š í”„ë¡œì„¸ìŠ¤ ìƒíƒœ:"
            ps aux | grep -E "node|npm" | grep -v grep | head -5
            
            # 13. í¬íŠ¸ í™•ì¸
            echo "ðŸ” í¬íŠ¸ 3000 ìƒíƒœ:"
            sudo netstat -tlnp | grep :3000 || echo "í¬íŠ¸ 3000 ë¦¬ìŠ¤ë‹ ì•ˆë¨"
            
            # 14. ë¡œê·¸ í™•ì¸
            echo "ðŸ“ ì„œë²„ ë¡œê·¸ (ìµœê·¼ 50ì¤„):"
            tail -50 ~/server.log
            
            # 15. ì ‘ì† í…ŒìŠ¤íŠ¸
            echo "ðŸ” ì„œë²„ ì‘ë‹µ í…ŒìŠ¤íŠ¸..."
            if curl -f -m 10 http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ… ì„œë²„ê°€ ì •ìƒ ìž‘ë™ ì¤‘!"
              echo "ðŸŒ ì ‘ì† ì£¼ì†Œ: http://13.209.84.93:3000"
            else
              echo "âš ï¸ ì„œë²„ ì‘ë‹µ ì—†ìŒ, PM2ë¡œ ìž¬ì‹œë„..."
              
              # PM2ë¡œ ìž¬ì‹œë„
              kill $SERVER_PID 2>/dev/null || true
              pm2 delete all 2>/dev/null || true
              
              # PM2 ì„¤ì •
              cat > ecosystem.config.js << 'PMEOF'
            module.exports = {
              apps: [{
                name: 'monsta-dev',
                script: 'npm',
                args: 'run dev',
                cwd: '/home/ubuntu/monstas7/frontend',
                instances: 1,
                exec_mode: 'fork',
                autorestart: true,
                watch: false,
                max_memory_restart: '500M',
                env: {
                  NODE_ENV: 'development',
                  PORT: 3000,
                  HOST: '0.0.0.0'
                }
              }]
            }
            PMEOF
              
              pm2 start ecosystem.config.js
              pm2 save
              
              sleep 10
              pm2 status
              pm2 logs monsta-dev --lines 30 --nostream
            fi
            
            # 16. ë©”ëª¨ë¦¬ ìƒíƒœ
            echo "ðŸ’¾ ë©”ëª¨ë¦¬ ìƒíƒœ:"
            free -h
            
            # 17. ìµœì¢… ë©”ì‹œì§€
            echo ""
            echo "âœ… í´ë¦° ìž¬ì‹œìž‘ ì™„ë£Œ!"
            echo "ðŸŒ ì ‘ì† URL: http://13.209.84.93:3000"
            echo "ðŸ“ ë¡œê·¸ ìœ„ì¹˜: ~/server.log"
            echo "ðŸ”„ ìž¬ì‹œìž‘: kill \$(pgrep -f 'npm run dev') && PORT=3000 npm run dev &"