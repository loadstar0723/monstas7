name: Debug Server

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - name: Debug Server Issues
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          timeout: 30m
          script: |
            echo "ðŸ” ì„œë²„ ë””ë²„ê¹… ì‹œìž‘..."
            echo "=================="
            
            # 1. í˜„ìž¬ í”„ë¡œì„¸ìŠ¤ í™•ì¸
            echo "1. í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤:"
            ps aux | grep -E "node|npm|pm2" | grep -v grep || echo "Node ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            echo ""
            
            # 2. PM2 ìƒíƒœ
            echo "2. PM2 ìƒíƒœ:"
            pm2 list || echo "PM2 ì‹¤í–‰ ì•ˆë¨"
            echo ""
            
            # 3. í¬íŠ¸ í™•ì¸
            echo "3. í¬íŠ¸ 3000 ì‚¬ìš© í˜„í™©:"
            sudo lsof -i :3000 || echo "í¬íŠ¸ 3000 ì‚¬ìš© ì•ˆí•¨"
            echo ""
            
            # 4. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸
            echo "4. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬:"
            ls -la ~/monstas7/ 2>/dev/null || echo "~/monstas7 ë””ë ‰í† ë¦¬ ì—†ìŒ"
            echo ""
            
            # 5. Frontend ë””ë ‰í† ë¦¬ í™•ì¸
            echo "5. Frontend ë””ë ‰í† ë¦¬:"
            ls -la ~/monstas7/frontend/ 2>/dev/null | head -20 || echo "Frontend ë””ë ‰í† ë¦¬ ì—†ìŒ"
            echo ""
            
            # 6. .next ë¹Œë“œ í™•ì¸
            echo "6. .next ë¹Œë“œ ë””ë ‰í† ë¦¬:"
            ls -la ~/monstas7/frontend/.next/ 2>/dev/null | head -10 || echo ".next ë””ë ‰í† ë¦¬ ì—†ìŒ"
            echo ""
            
            # 7. PM2 ë¡œê·¸ í™•ì¸
            echo "7. PM2 ìµœê·¼ ì—ëŸ¬ ë¡œê·¸:"
            pm2 logs --lines 50 --err --nostream 2>/dev/null || echo "PM2 ë¡œê·¸ ì—†ìŒ"
            echo ""
            
            # 8. ìˆ˜ë™ìœ¼ë¡œ ì„œë²„ ì‹œìž‘ ì‹œë„
            echo "8. ìˆ˜ë™ ì„œë²„ ì‹œìž‘ ì‹œë„:"
            cd ~/monstas7/frontend 2>/dev/null || {
              echo "Frontend ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ë¥¼ ë‹¤ì‹œ í´ë¡ í•©ë‹ˆë‹¤."
              cd ~
              git clone https://github.com/loadstar0723/monstas7.git
              cd monstas7/frontend
              npm install
              npx prisma generate
            }
            
            # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            export NODE_ENV=production
            export PORT=3000
            export HOST=0.0.0.0
            
            # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            timeout 30s npm start 2>&1 | head -50 || echo "ì„œë²„ ì‹œìž‘ ì‹¤íŒ¨"
            
            echo ""
            echo "9. ë„¤íŠ¸ì›Œí¬ ìƒíƒœ:"
            curl -I http://localhost:3000 2>/dev/null || echo "ë¡œì»¬ ì—°ê²° ì‹¤íŒ¨"
            
            echo ""
            echo "10. ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤:"
            free -m
            df -h | grep -E "/$|/dev/"
            
            echo "=================="
            echo "ë””ë²„ê¹… ì™„ë£Œ"