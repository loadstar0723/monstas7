name: Direct Deploy to AWS

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to AWS Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          timeout: 30m
          command_timeout: 30m
          script: |
            echo "ðŸš€ Starting deployment..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë˜ëŠ” í´ë¡ 
            if [ -d ~/monstas7 ]; then
              cd ~/monstas7
              echo "ðŸ“ Project directory exists"
            else
              cd ~
              git clone https://github.com/loadstar0723/monstas7.git
              cd monstas7
              echo "ðŸ“ Project cloned"
            fi
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ðŸ“¥ Pulling latest code..."
            git fetch --all
            git reset --hard origin/master
            
            # Frontend ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd frontend
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ðŸ“¦ Installing dependencies..."
            npm ci || npm install
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            echo "âš™ï¸ Setting environment variables..."
            cat > .env.local << 'EOF'
            NEXTAUTH_SECRET=monstas7-secret-key-2024-production-secure
            NEXTAUTH_URL=http://13.209.84.93:3000
            DATABASE_URL="file:./dev.db"
            NODE_ENV=production
            EOF
            
            # ë¹Œë“œ (ì—ëŸ¬ ë¬´ì‹œ)
            echo "ðŸ”¨ Building application..."
            npm run build || true
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            echo "ðŸ›‘ Stopping existing processes..."
            sudo pkill -f "next start" || true
            sudo pkill -f "node" || true
            sleep 2
            
            # PM2ë¡œ ì‹œìž‘
            echo "ðŸš€ Starting application with PM2..."
            npx pm2 delete all || true
            npx pm2 start npm --name "monstas7" -- start
            npx pm2 save
            
            # ìƒíƒœ í™•ì¸
            npx pm2 status
            
            echo "âœ… Deployment completed!"
            echo "ðŸŒ Access the site at: http://13.209.84.93:3000"