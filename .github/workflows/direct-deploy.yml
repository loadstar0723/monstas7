name: Direct Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Direct Deploy to Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.209.84.93
          username: ubuntu
          key: ${{ secrets.AWS_SERVER_KEY }}
          timeout: 30m
          script: |
            echo "ðŸš€ ì§ì ‘ ë°°í¬ ì‹œìž‘..."
            
            # 1. í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo "1ï¸âƒ£ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬"
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            pkill -f "node" 2>/dev/null || true
            
            # 2. í”„ë¡œì íŠ¸ ì—…ë°ì´íŠ¸
            echo "2ï¸âƒ£ ì½”ë“œ ì—…ë°ì´íŠ¸"
            cd ~/monstas7 || {
              cd ~
              git clone https://github.com/loadstar0723/monstas7.git
              cd monstas7
            }
            git fetch origin master
            git reset --hard origin/master
            
            # 3. Frontend ì„¤ì •
            echo "3ï¸âƒ£ Frontend ì„¤ì •"
            cd frontend
            
            # í™˜ê²½ ë³€ìˆ˜
            cat > .env.local << 'EOF'
            NEXTAUTH_SECRET=monstas7-secret-key-2024-production-secure
            NEXTAUTH_URL=http://13.209.84.93:3000
            DATABASE_URL="file:./dev.db"
            EOF
            
            # 4. ì˜ì¡´ì„± ì„¤ì¹˜
            echo "4ï¸âƒ£ ì˜ì¡´ì„± ì„¤ì¹˜"
            npm ci || npm install
            
            # 5. Prisma ì„¤ì •
            echo "5ï¸âƒ£ Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„±"
            npx prisma generate || echo "Prisma generate ì‹¤íŒ¨, ê³„ì† ì§„í–‰"
            
            # 6. ë¹Œë“œ ì‹œë„
            echo "6ï¸âƒ£ í”„ë¡œë•ì…˜ ë¹Œë“œ"
            npm run build || {
              echo "ë¹Œë“œ ì‹¤íŒ¨! ê°œë°œ ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤."
              NODE_ENV=development
            }
            
            # 7. PM2ë¡œ ì‹¤í–‰
            echo "7ï¸âƒ£ PM2ë¡œ ì„œë²„ ì‹œìž‘"
            cd ~/monstas7
            
            # PM2 ecosystem ì„¤ì • í™•ì¸
            if [ -f ecosystem.config.js ]; then
              pm2 start ecosystem.config.js
            else
              echo "ecosystem.config.js ì—†ìŒ, ì§ì ‘ ì‹¤í–‰"
              cd frontend
              pm2 start npm --name "monsta-prod" -- start
            fi
            
            # 8. PM2 ì €ìž¥
            pm2 save
            pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
            
            # 9. ëŒ€ê¸°
            echo "8ï¸âƒ£ ì„œë²„ ì‹œìž‘ ëŒ€ê¸°ì¤‘..."
            sleep 15
            
            # 10. ìƒíƒœ í™•ì¸
            echo "9ï¸âƒ£ ì„œë²„ ìƒíƒœ í™•ì¸"
            pm2 status
            pm2 logs --lines 50 --nostream
            
            # 11. í…ŒìŠ¤íŠ¸
            echo "ðŸ”Ÿ ì—°ê²° í…ŒìŠ¤íŠ¸"
            curl -I http://localhost:3000 || echo "ë¡œì»¬ ì—°ê²° ì‹¤íŒ¨"
            curl -I http://localhost:3000/test || echo "í…ŒìŠ¤íŠ¸ íŽ˜ì´ì§€ ì ‘ì† ì‹¤íŒ¨"
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "ðŸŒ http://13.209.84.93:3000"