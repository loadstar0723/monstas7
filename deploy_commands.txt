#!/bin/bash
# MONSTA V7 서버 배포 명령어

# 1. 디렉토리 생성
mkdir -p ~/monsta-v7
cd ~/monsta-v7

# 2. 기존 프로젝트 백업 (있다면)
if [ -d "monstas7" ]; then
    mv monstas7 monstas7_backup_$(date +%Y%m%d_%H%M%S)
fi

# 3. GitHub에서 클론
git clone https://github.com/loadstar0723/monstas7.git
cd monstas7

# 4. Docker 설치 (없으면)
if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    sudo usermod -aG docker $USER
fi

# 5. Docker Compose 설치
if ! command -v docker-compose &> /dev/null; then
    sudo apt-get update
    sudo apt-get install -y docker-compose
fi

# 6. 환경변수 파일 생성
cat > .env << EOF
BINANCE_API_KEY=your_api_key_here
BINANCE_API_SECRET=your_api_secret_here
PORT=8507
DB_HOST=localhost
DB_PORT=5437
REDIS_PORT=6387
EOF

# 7. Docker 컨테이너 시작
sudo docker-compose -f docker-compose.server.yml down
sudo docker-compose -f docker-compose.server.yml up -d

# 8. 상태 확인
echo "========================================="
echo "Deployment Status:"
sudo docker ps
echo "========================================="
echo "Server is running at port 8507"
echo "=========================================