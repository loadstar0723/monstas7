'use client'

import { useState, useEffect, useRef } from 'react'
import dynamic from 'next/dynamic'

// Ïª¥Ìè¨ÎÑåÌä∏ ÎèôÏ†Å ÏûÑÌè¨Ìä∏ (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
const CoinSelector = dynamic(() => import('./components/CoinSelector'), {
  loading: () => <div className="animate-pulse h-16 bg-gray-800/50 rounded-lg" />,
  ssr: false
})

const ConceptSection = dynamic(() => import('./components/ConceptSection'), {
  loading: () => <div className="animate-pulse h-48 bg-gray-800/50 rounded-lg" />,
  ssr: false
})

const RealtimeAnalysis = dynamic(() => import('./components/RealtimeAnalysis'), {
  loading: () => <div className="animate-pulse h-64 bg-gray-800/50 rounded-lg" />,
  ssr: false
})

const PriceChart = dynamic(() => import('./components/PriceChart'), {
  loading: () => <div className="animate-pulse h-96 bg-gray-800/50 rounded-lg" />,
  ssr: false
})

const BollingerBands = dynamic(() => import('./components/BollingerBands'), {
  loading: () => <div className="animate-pulse h-80 bg-gray-800/50 rounded-lg" />,
  ssr: false
})

const ZScoreAnalysis = dynamic(() => import('./components/ZScoreAnalysis'), {
  loading: () => <div className="animate-pulse h-80 bg-gray-800/50 rounded-lg" />,
  ssr: false
})

const RSIDivergence = dynamic(() => import('./components/RSIDivergence'), {
  loading: () => <div className="animate-pulse h-80 bg-gray-800/50 rounded-lg" />,
  ssr: false
})

const TradingSignals = dynamic(() => import('./components/TradingSignals'), {
  loading: () => <div className="animate-pulse h-96 bg-gray-800/50 rounded-lg" />,
  ssr: false
})

const BacktestResults = dynamic(() => import('./components/BacktestResults'), {
  loading: () => <div className="animate-pulse h-96 bg-gray-800/50 rounded-lg" />,
  ssr: false
})

const RiskManagement = dynamic(() => import('./components/RiskManagement'), {
  loading: () => <div className="animate-pulse h-64 bg-gray-800/50 rounded-lg" />,
  ssr: false
})

const StrategyGuide = dynamic(() => import('./components/StrategyGuide'), {
  loading: () => <div className="animate-pulse h-96 bg-gray-800/50 rounded-lg" />,
  ssr: false
})

const AIRecommendation = dynamic(() => import('./components/AIRecommendation'), {
  loading: () => <div className="animate-pulse h-64 bg-gray-800/50 rounded-lg" />,
  ssr: false
})

// 10Í∞ú Ï£ºÏöî ÏΩîÏù∏ Ï†ïÎ≥¥
export const COINS = [
  { symbol: 'BTCUSDT', name: 'Bitcoin', icon: '‚Çø', color: '#F7931A', initialPrice: 98000 },
  { symbol: 'ETHUSDT', name: 'Ethereum', icon: 'Œû', color: '#627EEA', initialPrice: 3500 },
  { symbol: 'BNBUSDT', name: 'BNB', icon: 'üî∏', color: '#F3BA2F', initialPrice: 700 },
  { symbol: 'SOLUSDT', name: 'Solana', icon: '‚óé', color: '#14F195', initialPrice: 240 },
  { symbol: 'XRPUSDT', name: 'XRP', icon: '‚úï', color: '#23292F', initialPrice: 2.5 },
  { symbol: 'ADAUSDT', name: 'Cardano', icon: '‚Ç≥', color: '#0033AD', initialPrice: 1.0 },
  { symbol: 'DOGEUSDT', name: 'Dogecoin', icon: '√ê', color: '#C2A633', initialPrice: 0.4 },
  { symbol: 'AVAXUSDT', name: 'Avalanche', icon: 'üî∫', color: '#E84142', initialPrice: 45 },
  { symbol: 'MATICUSDT', name: 'Polygon', icon: '‚¨ü', color: '#8247E5', initialPrice: 1.5 },
  { symbol: 'DOTUSDT', name: 'Polkadot', icon: '‚ö™', color: '#E6007A', initialPrice: 10 }
]

interface MarketData {
  price: number
  change24h: number
  volume24h: number
  high24h: number
  low24h: number
  sma20: number
  sma50: number
  sma200: number
  upperBand: number
  lowerBand: number
  zScore: number
  rsi: number
}

export default function MeanReversionModule() {
  const [selectedCoin, setSelectedCoin] = useState(COINS[0])
  const [marketData, setMarketData] = useState<MarketData | null>(null)
  const [historicalData, setHistoricalData] = useState<any[]>([])
  const [loading, setLoading] = useState(true)
  const wsRef = useRef<WebSocket | null>(null)
  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null)

  // WebSocket Ïó∞Í≤∞ Í¥ÄÎ¶¨
  const connectWebSocket = (symbol: string) => {
    try {
      // Í∏∞Ï°¥ Ïó∞Í≤∞ Ï†ïÎ¶¨
      if (wsRef.current) {
        wsRef.current.onclose = null
        wsRef.current.onerror = null
        wsRef.current.onmessage = null
        wsRef.current.close()
        wsRef.current = null
      }

      // Ïû¨Ïó∞Í≤∞ ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
      if (reconnectTimeoutRef.current) {
        clearTimeout(reconnectTimeoutRef.current)
        reconnectTimeoutRef.current = null
      }

      const wsUrl = `wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@ticker`
      
      try {
        wsRef.current = new WebSocket(wsUrl)
      } catch (e) {
        console.log('WebSocket ÏÉùÏÑ± Ïã§Ìå®, 3Ï¥à ÌõÑ Ïû¨ÏãúÎèÑ')
        reconnectTimeoutRef.current = setTimeout(() => {
          connectWebSocket(symbol)
        }, 3000)
        return
      }

      wsRef.current.onopen = () => {
        console.log(`WebSocket Ïó∞Í≤∞ ÏÑ±Í≥µ: ${symbol}`)
      }

      wsRef.current.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data)
          
          setMarketData(prev => ({
            price: parseFloat(data.c) || prev?.price || 0,
            change24h: parseFloat(data.P) || prev?.change24h || 0,
            volume24h: parseFloat(data.v) || prev?.volume24h || 0,
            high24h: parseFloat(data.h) || prev?.high24h || 0,
            low24h: parseFloat(data.l) || prev?.low24h || 0,
            sma20: prev?.sma20 || parseFloat(data.c),
            sma50: prev?.sma50 || parseFloat(data.c),
            sma200: prev?.sma200 || parseFloat(data.c),
            upperBand: prev?.upperBand || parseFloat(data.c) * 1.02,
            lowerBand: prev?.lowerBand || parseFloat(data.c) * 0.98,
            zScore: prev?.zScore || 0,
            rsi: prev?.rsi || 50
          }))
        } catch (error) {
          console.log('Îç∞Ïù¥ÌÑ∞ ÌååÏã± ÏóêÎü¨:', error)
        }
      }

      wsRef.current.onerror = (event) => {
        console.log('WebSocket Ïó∞Í≤∞ ÏóêÎü¨, 3Ï¥à ÌõÑ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ')
      }

      wsRef.current.onclose = (event) => {
        console.log(`WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å (ÏΩîÎìú: ${event.code})`)
        wsRef.current = null
        
        // Ï†ïÏÉÅ Ï¢ÖÎ£åÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ Ïû¨Ïó∞Í≤∞
        if (event.code !== 1000) {
          if (reconnectTimeoutRef.current) {
            clearTimeout(reconnectTimeoutRef.current)
          }
          reconnectTimeoutRef.current = setTimeout(() => {
            console.log('WebSocket Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ...')
            connectWebSocket(symbol)
          }, 3000)
        }
      }
    } catch (error) {
      console.log('WebSocket ÏÑ§Ï†ï ÏóêÎü¨:', error)
      // 3Ï¥à ÌõÑ Ïû¨ÏãúÎèÑ
      reconnectTimeoutRef.current = setTimeout(() => {
        connectWebSocket(symbol)
      }, 3000)
    }
  }

  // Í≥ºÍ±∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  const loadHistoricalData = async (symbol: string) => {
    try {
      const response = await fetch(`/api/binance/klines?symbol=${symbol}&interval=1d&limit=200`)
      if (response.ok) {
        const data = await response.json()
        setHistoricalData(data)
        
        // Ïù¥ÎèôÌèâÍ∑† Í≥ÑÏÇ∞
        if (data.length >= 200) {
          const prices = data.map((d: any) => parseFloat(d[4]))
          const sma20 = prices.slice(-20).reduce((a: number, b: number) => a + b, 0) / 20
          const sma50 = prices.slice(-50).reduce((a: number, b: number) => a + b, 0) / 50
          const sma200 = prices.reduce((a: number, b: number) => a + b, 0) / 200
          
          // Î≥ºÎ¶∞Ï†Ä Î∞¥Îìú Í≥ÑÏÇ∞
          const stdDev = Math.sqrt(
            prices.slice(-20).reduce((sum: number, price: number) => {
              return sum + Math.pow(price - sma20, 2)
            }, 0) / 20
          )
          
          // Z-Score Í≥ÑÏÇ∞
          const currentPrice = prices[prices.length - 1]
          const zScore = (currentPrice - sma20) / stdDev
          
          // RSI Í≥ÑÏÇ∞ (Í∞ÑÎã® Î≤ÑÏ†Ñ)
          let gains = 0, losses = 0
          for (let i = prices.length - 14; i < prices.length; i++) {
            const change = prices[i] - prices[i - 1]
            if (change > 0) gains += change
            else losses += Math.abs(change)
          }
          const avgGain = gains / 14
          const avgLoss = losses / 14
          const rs = avgGain / (avgLoss || 1)
          const rsi = 100 - (100 / (1 + rs))
          
          // 24ÏãúÍ∞Ñ ÏµúÍ≥†/ÏµúÏ†ÄÍ∞Ä Í≥ÑÏÇ∞
          const recent24h = data.slice(-24)
          const high24h = Math.max(...recent24h.map((d: any) => parseFloat(d[2])))
          const low24h = Math.min(...recent24h.map((d: any) => parseFloat(d[3])))
          
          setMarketData(prev => ({
            ...prev!,
            sma20,
            sma50,
            sma200,
            upperBand: sma20 + (stdDev * 2),
            lowerBand: sma20 - (stdDev * 2),
            zScore,
            rsi,
            high24h,
            low24h
          }))
        }
      }
    } catch (error) {
      console.error('Í≥ºÍ±∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error)
    } finally {
      setLoading(false)
    }
  }

  // ÏΩîÏù∏ Î≥ÄÍ≤Ω Ïãú
  useEffect(() => {
    setLoading(true)
    setMarketData({
      price: selectedCoin.initialPrice,
      change24h: 0,
      volume24h: 0,
      high24h: selectedCoin.initialPrice * 1.05,
      low24h: selectedCoin.initialPrice * 0.95,
      sma20: selectedCoin.initialPrice,
      sma50: selectedCoin.initialPrice,
      sma200: selectedCoin.initialPrice,
      upperBand: selectedCoin.initialPrice * 1.02,
      lowerBand: selectedCoin.initialPrice * 0.98,
      zScore: 0,
      rsi: 50
    })
    
    connectWebSocket(selectedCoin.symbol)
    loadHistoricalData(selectedCoin.symbol)

    return () => {
      // Ï†ïÎ¶¨ Ïãú Ïû¨Ïó∞Í≤∞ Î∞©ÏßÄ
      if (reconnectTimeoutRef.current) {
        clearTimeout(reconnectTimeoutRef.current)
        reconnectTimeoutRef.current = null
      }
      
      if (wsRef.current) {
        // Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ Ï†úÍ±∞Î°ú Ïû¨Ïó∞Í≤∞ Î∞©ÏßÄ
        wsRef.current.onclose = null
        wsRef.current.onerror = null
        wsRef.current.onmessage = null
        wsRef.current.onopen = null
        
        // Ï†ïÏÉÅ Ï¢ÖÎ£å ÏΩîÎìúÎ°ú Îã´Í∏∞
        if (wsRef.current.readyState === WebSocket.OPEN) {
          wsRef.current.close(1000, 'Component unmounting')
        }
        wsRef.current = null
      }
    }
  }, [selectedCoin])

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-black to-gray-900">
      {/* Ìó§Îçî */}
      <div className="border-b border-gray-800 sticky top-0 bg-black/90 backdrop-blur-sm z-40">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <h1 className="text-2xl md:text-3xl font-bold text-white">
            ÌèâÍ∑†ÌöåÍ∑Ä Ï†ÑÎ¨∏ Î∂ÑÏÑù
          </h1>
          <p className="text-gray-400 text-sm md:text-base mt-1">
            Mean Reversion Strategy - Í∞ÄÍ≤©ÏùÄ Í≤∞Íµ≠ ÌèâÍ∑†ÏúºÎ°ú ÎèåÏïÑÏò®Îã§
          </p>
        </div>
      </div>

      {/* ÏΩîÏù∏ ÏÑ†ÌÉù */}
      <div className="sticky top-[73px] bg-black/90 backdrop-blur-sm z-30 border-b border-gray-800">
        <CoinSelector 
          coins={COINS}
          selectedCoin={selectedCoin}
          onSelectCoin={setSelectedCoin}
        />
      </div>

      {/* Î©îÏù∏ ÏΩòÌÖêÏ∏† */}
      <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
        {/* Í∞úÎÖê ÏÑ§Î™Ö ÏÑπÏÖò */}
        <ConceptSection coinName={selectedCoin.name} />

        {/* Ïã§ÏãúÍ∞Ñ Î∂ÑÏÑù */}
        <RealtimeAnalysis 
          coin={selectedCoin}
          marketData={marketData}
          loading={loading}
        />

        {/* Ï∞®Ìä∏ ÏÑπÏÖò */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <PriceChart 
            coin={selectedCoin}
            historicalData={historicalData}
            marketData={marketData}
          />
          <BollingerBands 
            coin={selectedCoin}
            historicalData={historicalData}
            marketData={marketData}
          />
        </div>

        {/* ÏßÄÌëú Î∂ÑÏÑù */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <ZScoreAnalysis 
            coin={selectedCoin}
            marketData={marketData}
            historicalData={historicalData}
          />
          <RSIDivergence 
            coin={selectedCoin}
            marketData={marketData}
            historicalData={historicalData}
          />
        </div>

        {/* Ìä∏Î†àÏù¥Îî© ÏãúÍ∑∏ÎÑê */}
        <TradingSignals 
          coin={selectedCoin}
          marketData={marketData}
        />

        {/* Î∞±ÌÖåÏä§ÌåÖ Í≤∞Í≥º */}
        <BacktestResults 
          coin={selectedCoin}
          historicalData={historicalData}
        />

        {/* Î¶¨Ïä§ÌÅ¨ Í¥ÄÎ¶¨ */}
        <RiskManagement 
          coin={selectedCoin}
          marketData={marketData}
        />

        {/* Ï†ÑÎûµ Í∞ÄÏù¥Îìú */}
        <StrategyGuide 
          coin={selectedCoin}
          marketData={marketData}
        />

        {/* AI Ï∂îÏ≤ú */}
        <AIRecommendation 
          coin={selectedCoin}
          marketData={marketData}
        />
      </div>
    </div>
  )
}