'use client'

import { useState, useEffect } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { socialSentimentService, type SocialMention, type MarketCorrelation, type EconomicIndicator } from '@/lib/services/socialSentimentService'
import { Line, Bar, Doughnut } from 'react-chartjs-2'
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
  Filler
} from 'chart.js'

ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
  Filler
)

// ë²ˆì—­ í•¨ìˆ˜
const translateText = async (text: string, toKorean: boolean) => {
  try {
    const response = await fetch('/api/translate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text,
        targetLang: toKorean ? 'ko' : 'en'
      })
    })
    const data = await response.json()
    return data.translatedText || text
  } catch (error) {
    console.error('ë²ˆì—­ ì‹¤íŒ¨:', error)
    return text
  }
}

export default function SocialAnalysisPage() {
  const [selectedSymbol, setSelectedSymbol] = useState('BTC')
  const [redditMentions, setRedditMentions] = useState<SocialMention[]>([])
  const [twitterMentions, setTwitterMentions] = useState<SocialMention[]>([])
  const [correlation, setCorrelation] = useState<MarketCorrelation | null>(null)
  const [economicIndicators, setEconomicIndicators] = useState<EconomicIndicator[]>([])
  const [loading, setLoading] = useState(true)
  const [activeTab, setActiveTab] = useState<'reddit' | 'twitter' | 'correlation' | 'economy'>('reddit')
  const [isKorean, setIsKorean] = useState(true) // ê¸°ë³¸ê°’ì„ í•œêµ­ì–´ë¡œ ì„¤ì •
  const [translating, setTranslating] = useState(false)
  const [translatedMentions, setTranslatedMentions] = useState<Record<string, string>>({})

  const symbols = [
    'ALL', 'BTC', 'ETH', 'BNB', 'SOL', 'XRP', 'ADA', 'DOGE', 'AVAX', 'MATIC',
    'LINK', 'DOT', 'UNI', 'ATOM', 'LTC', 'ETC', 'ICP', 'FIL', 'APT', 'ARB',
    'OP', 'NEAR', 'VET', 'ALGO', 'FTM', 'GRT', 'SAND', 'MANA', 'AXS', 'THETA',
    'EGLD', 'FLOW', 'XTZ', 'CHZ', 'ENJ', 'ZIL', 'HBAR', 'KLAY', 'CRV', 'MKR',
    'AAVE', 'SNX', 'COMP', 'YFI', 'SUSHI', 'UMA', 'ZRX', 'BAT', 'ENS', 'LDO',
    'IMX', 'WLD', 'SEI', 'SUI', 'TIA', 'BLUR', 'JTO', 'PYTH', 'JUP', 'STRK'
  ]

  useEffect(() => {
    fetchSocialData()
  }, [selectedSymbol])

  // ì–¸ì–´ ë³€ê²½ ì‹œ ëª¨ë“  ë©˜ì…˜ ë²ˆì—­
  useEffect(() => {
    if (isKorean) {
      translateAllMentions()
    }
  }, [isKorean, redditMentions, twitterMentions])

  const fetchSocialData = async () => {
    setLoading(true)
    try {
      // ALL ì„ íƒ ì‹œ ìƒìœ„ 10ê°œ ì½”ì¸ ë¶„ì„
      const symbolsToFetch = selectedSymbol === 'ALL'
        ? ['BTC', 'ETH', 'BNB', 'SOL', 'XRP', 'ADA', 'DOGE', 'AVAX', 'MATIC', 'LINK']
        : [selectedSymbol]

      const [reddit, twitter, corr, econ] = await Promise.all([
        socialSentimentService.fetchRedditMentions(symbolsToFetch),
        socialSentimentService.fetchTwitterMentions(symbolsToFetch),
        selectedSymbol === 'ALL'
          ? Promise.resolve(null)
          : socialSentimentService.analyzeNewsCorrelation(selectedSymbol),
        socialSentimentService.fetchEconomicIndicators()
      ])

      setRedditMentions(reddit)
      setTwitterMentions(twitter)
      setCorrelation(corr)
      setEconomicIndicators(econ)
    } catch (error) {
      console.error('ì†Œì…œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error)
    } finally {
      setLoading(false)
    }
  }

  const translateAllMentions = async () => {
    if (!isKorean) {
      setTranslatedMentions({})
      return
    }

    setTranslating(true)
    try {
      const allMentions = [...redditMentions, ...twitterMentions]
      const translations: Record<string, string> = {}

      // ë°°ì¹˜ë¡œ ë²ˆì—­ ì²˜ë¦¬
      for (const mention of allMentions) {
        if (!translatedMentions[mention.id]) {
          const translated = await translateText(mention.content, true)
          translations[mention.id] = translated
        } else {
          translations[mention.id] = translatedMentions[mention.id]
        }
      }

      setTranslatedMentions(translations)
    } catch (error) {
      console.error('ë²ˆì—­ ì‹¤íŒ¨:', error)
    } finally {
      setTranslating(false)
    }
  }

  const calculateSentiment = (mentions: SocialMention[]) => {
    const positive = mentions.filter(m => m.sentiment === 'positive').length
    const negative = mentions.filter(m => m.sentiment === 'negative').length
    const neutral = mentions.filter(m => m.sentiment === 'neutral').length
    return { positive, negative, neutral }
  }

  const sentimentChartData = {
    labels: ['ê¸ì •ì ', 'ë¶€ì •ì ', 'ì¤‘ë¦½'],
    datasets: [{
      data: (() => {
        const mentions = activeTab === 'reddit' ? redditMentions : twitterMentions
        const sentiment = calculateSentiment(mentions)
        return [sentiment.positive, sentiment.negative, sentiment.neutral]
      })(),
      backgroundColor: ['#10b981', '#ef4444', '#6b7280'],
      borderWidth: 0
    }]
  }

  const correlationChartData = {
    labels: ['ë‰´ìŠ¤ ì˜í–¥ë„', 'ì†Œì…œ ê°ì„±', 'ê°€ê²© ìƒê´€ê´€ê³„', 'ê±°ë˜ëŸ‰ ì˜í–¥'],
    datasets: [{
      label: `${selectedSymbol} ìƒê´€ê´€ê³„ ë¶„ì„`,
      data: correlation ? [
        correlation.newsImpact,
        correlation.socialSentiment,
        correlation.priceCorrelation * 100,
        correlation.volumeImpact
      ] : [],
      backgroundColor: 'rgba(139, 92, 246, 0.2)',
      borderColor: 'rgba(139, 92, 246, 1)',
      borderWidth: 2
    }]
  }

  const economicChartData = {
    labels: economicIndicators.map(e => e.name),
    datasets: [{
      label: 'ì•”í˜¸í™”í ìƒê´€ê´€ê³„',
      data: economicIndicators.map(e => e.cryptoCorrelation * 100),
      backgroundColor: economicIndicators.map(e =>
        e.cryptoCorrelation > 0 ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)'
      ),
      borderColor: economicIndicators.map(e =>
        e.cryptoCorrelation > 0 ? '#10b981' : '#ef4444'
      ),
      borderWidth: 2
    }]
  }

  return (
    <div className="min-h-screen bg-gray-900 text-white p-6">
      <div className="max-w-7xl mx-auto">
        {/* í—¤ë” */}
        <div className="mb-8 flex justify-between items-start">
          <div>
            <h1 className="text-4xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
              ğŸŒ ì†Œì…œ ë¯¸ë””ì–´ & ê²½ì œ ìƒê´€ê´€ê³„ ë¶„ì„
            </h1>
            <p className="text-gray-400">Reddit, Twitter ì‹¤ì‹œê°„ ê°ì„± ë¶„ì„ ë° ê²½ì œ ì§€í‘œ ì—°ë™</p>
          </div>
          <button
            onClick={() => setIsKorean(!isKorean)}
            className="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-all flex items-center gap-2"
            disabled={translating}
          >
            ğŸŒ {isKorean ? 'ì˜ì–´ë¡œ ë³´ê¸°' : 'í•œêµ­ì–´ë¡œ ë³´ê¸°'}
            {translating && <span className="animate-spin">â³</span>}
          </button>
        </div>

        {/* ì‹¬ë³¼ ì„ íƒ */}
        <div className="flex flex-wrap gap-2 mb-6">
          {symbols.map(symbol => (
            <button
              key={symbol}
              onClick={() => setSelectedSymbol(symbol)}
              className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                selectedSymbol === symbol
                  ? 'bg-purple-600 text-white'
                  : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
              }`}
            >
              {symbol === 'ALL' ? 'ğŸŒ ì „ì²´' : symbol}
            </button>
          ))}
        </div>

        {/* íƒ­ ë©”ë‰´ */}
        <div className="flex space-x-2 mb-6 border-b border-gray-700">
          <button
            onClick={() => setActiveTab('reddit')}
            className={`px-4 py-2 font-semibold transition-all ${
              activeTab === 'reddit'
                ? 'text-purple-400 border-b-2 border-purple-400'
                : 'text-gray-400 hover:text-white'
            }`}
          >
            Reddit ë¶„ì„
          </button>
          <button
            onClick={() => setActiveTab('twitter')}
            className={`px-4 py-2 font-semibold transition-all ${
              activeTab === 'twitter'
                ? 'text-purple-400 border-b-2 border-purple-400'
                : 'text-gray-400 hover:text-white'
            }`}
          >
            Twitter ë¶„ì„
          </button>
          <button
            onClick={() => setActiveTab('correlation')}
            className={`px-4 py-2 font-semibold transition-all ${
              activeTab === 'correlation'
                ? 'text-purple-400 border-b-2 border-purple-400'
                : 'text-gray-400 hover:text-white'
            }`}
          >
            ë‰´ìŠ¤ ìƒê´€ê´€ê³„
          </button>
          <button
            onClick={() => setActiveTab('economy')}
            className={`px-4 py-2 font-semibold transition-all ${
              activeTab === 'economy'
                ? 'text-purple-400 border-b-2 border-purple-400'
                : 'text-gray-400 hover:text-white'
            }`}
          >
            ê²½ì œ ì§€í‘œ
          </button>
        </div>

        {loading ? (
          <div className="flex justify-center items-center h-64">
            <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-400"></div>
          </div>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* ì™¼ìª½: ë©˜ì…˜ ë¦¬ìŠ¤íŠ¸ */}
            <div className="bg-gray-800 rounded-xl p-6">
              <h2 className="text-xl font-bold mb-4">
                {activeTab === 'reddit' && 'ğŸ”¥ Reddit ì¸ê¸° ë©˜ì…˜'}
                {activeTab === 'twitter' && 'ğŸ¦ Twitter íŠ¸ë Œë”©'}
                {activeTab === 'correlation' && 'ğŸ“Š ë‰´ìŠ¤-ê°€ê²© ìƒê´€ê´€ê³„'}
                {activeTab === 'economy' && 'ğŸ’¹ ê²½ì œ ì§€í‘œ ì˜í–¥ë„'}
              </h2>

              {(activeTab === 'reddit' || activeTab === 'twitter') && (
                <div className="space-y-4 max-h-96 overflow-y-auto">
                  {(activeTab === 'reddit' ? redditMentions : twitterMentions).map(mention => (
                    <motion.div
                      key={mention.id}
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="bg-gray-700 rounded-lg p-4"
                    >
                      <div className="flex justify-between items-start mb-2">
                        <span className="font-semibold text-purple-400">{mention.author}</span>
                        <span className={`px-2 py-1 rounded text-xs ${
                          mention.sentiment === 'positive' ? 'bg-green-600' :
                          mention.sentiment === 'negative' ? 'bg-red-600' : 'bg-gray-600'
                        }`}>
                          {mention.sentiment === 'positive' ? 'ê¸ì •' :
                           mention.sentiment === 'negative' ? 'ë¶€ì •' : 'ì¤‘ë¦½'}
                        </span>
                      </div>
                      <p className="text-gray-300 text-sm mb-2">
                        {isKorean && translatedMentions[mention.id]
                          ? translatedMentions[mention.id]
                          : mention.content}
                      </p>
                      <div className="flex justify-between text-xs text-gray-500">
                        <span>ğŸ‘ {mention.engagement.likes} | ğŸ’¬ {mention.engagement.comments} | ğŸ”„ {mention.engagement.shares}</span>
                        <span>{new Date(mention.timestamp).toLocaleTimeString('ko-KR')}</span>
                      </div>
                    </motion.div>
                  ))}
                </div>
              )}

              {activeTab === 'correlation' && correlation && (
                <div className="space-y-4">
                  <div className="bg-gray-700 rounded-lg p-4">
                    <h3 className="font-semibold mb-2">ë‰´ìŠ¤ ì˜í–¥ë„</h3>
                    <div className="flex items-center">
                      <div className="flex-1 bg-gray-600 rounded-full h-4">
                        <div
                          className="bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full"
                          style={{ width: `${correlation.newsImpact}%` }}
                        />
                      </div>
                      <span className="ml-3 font-bold">{correlation.newsImpact}%</span>
                    </div>
                  </div>
                  <div className="bg-gray-700 rounded-lg p-4">
                    <h3 className="font-semibold mb-2">ì†Œì…œ ê°ì„± ì ìˆ˜</h3>
                    <div className="flex items-center">
                      <div className="flex-1 bg-gray-600 rounded-full h-4">
                        <div
                          className="bg-gradient-to-r from-blue-500 to-cyan-500 h-4 rounded-full"
                          style={{ width: `${correlation.socialSentiment}%` }}
                        />
                      </div>
                      <span className="ml-3 font-bold">{correlation.socialSentiment}%</span>
                    </div>
                  </div>
                  <div className="bg-gray-700 rounded-lg p-4">
                    <h3 className="font-semibold mb-2">ê°€ê²© ìƒê´€ê´€ê³„</h3>
                    <div className="text-3xl font-bold text-center">
                      {(correlation.priceCorrelation * 100).toFixed(1)}%
                    </div>
                    <p className="text-sm text-gray-400 text-center mt-2">
                      {correlation.priceCorrelation > 0.7 ? 'ë§¤ìš° ê°•í•œ ìƒê´€ê´€ê³„' :
                       correlation.priceCorrelation > 0.4 ? 'ë³´í†µ ìƒê´€ê´€ê³„' : 'ì•½í•œ ìƒê´€ê´€ê³„'}
                    </p>
                  </div>
                </div>
              )}

              {activeTab === 'economy' && (
                <div className="space-y-3">
                  {economicIndicators.map((indicator, index) => (
                    <div key={index} className="bg-gray-700 rounded-lg p-4">
                      <div className="flex justify-between items-center mb-2">
                        <h3 className="font-semibold">{indicator.name}</h3>
                        <span className={`px-2 py-1 rounded text-xs ${
                          indicator.impact === 'high' ? 'bg-red-600' :
                          indicator.impact === 'medium' ? 'bg-yellow-600' : 'bg-gray-600'
                        }`}>
                          {indicator.impact === 'high' ? 'ë†’ìŒ' :
                           indicator.impact === 'medium' ? 'ì¤‘ê°„' : 'ë‚®ìŒ'}
                        </span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span>í˜„ì¬: {indicator.value}</span>
                        <span className={indicator.change > 0 ? 'text-green-400' : 'text-red-400'}>
                          {indicator.change > 0 ? '+' : ''}{indicator.change}%
                        </span>
                      </div>
                      <div className="mt-2">
                        <div className="text-xs text-gray-400">ì•”í˜¸í™”í ìƒê´€ê´€ê³„</div>
                        <div className={`text-lg font-bold ${
                          indicator.cryptoCorrelation > 0 ? 'text-green-400' : 'text-red-400'
                        }`}>
                          {(indicator.cryptoCorrelation * 100).toFixed(1)}%
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* ì˜¤ë¥¸ìª½: ì°¨íŠ¸ */}
            <div className="space-y-6">
              {(activeTab === 'reddit' || activeTab === 'twitter') && (
                <>
                  <div className="bg-gray-800 rounded-xl p-6">
                    <h2 className="text-xl font-bold mb-4">ê°ì„± ë¶„ì„ ì°¨íŠ¸</h2>
                    <Doughnut
                      data={sentimentChartData}
                      options={{
                        responsive: true,
                        plugins: {
                          legend: {
                            position: 'bottom',
                            labels: { color: 'white' }
                          }
                        }
                      }}
                    />
                  </div>
                  <div className="bg-gray-800 rounded-xl p-6">
                    <h2 className="text-xl font-bold mb-4">ì¢…í•© ê°ì„± ì ìˆ˜</h2>
                    <div className="text-center">
                      <div className="text-5xl font-bold mb-2">
                        {socialSentimentService.calculateOverallSentiment(
                          activeTab === 'reddit' ? redditMentions : twitterMentions
                        ).toFixed(0)}
                      </div>
                      <div className="text-gray-400">
                        {socialSentimentService.calculateOverallSentiment(
                          activeTab === 'reddit' ? redditMentions : twitterMentions
                        ) > 60 ? 'ğŸš€ ë§¤ìš° ê¸ì •ì ' :
                         socialSentimentService.calculateOverallSentiment(
                          activeTab === 'reddit' ? redditMentions : twitterMentions
                        ) > 40 ? 'ğŸ˜Š ê¸ì •ì ' :
                         socialSentimentService.calculateOverallSentiment(
                          activeTab === 'reddit' ? redditMentions : twitterMentions
                        ) > -40 ? 'ğŸ˜ ì¤‘ë¦½' :
                         socialSentimentService.calculateOverallSentiment(
                          activeTab === 'reddit' ? redditMentions : twitterMentions
                        ) > -60 ? 'ğŸ˜Ÿ ë¶€ì •ì ' : 'ğŸ˜± ë§¤ìš° ë¶€ì •ì '}
                      </div>
                    </div>
                  </div>
                </>
              )}

              {activeTab === 'correlation' && (
                <div className="bg-gray-800 rounded-xl p-6">
                  <h2 className="text-xl font-bold mb-4">ìƒê´€ê´€ê³„ ë¶„ì„ ì°¨íŠ¸</h2>
                  <Bar
                    data={correlationChartData}
                    options={{
                      responsive: true,
                      scales: {
                        y: {
                          beginAtZero: true,
                          max: 100,
                          ticks: { color: 'white' },
                          grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                          ticks: { color: 'white' },
                          grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                      },
                      plugins: {
                        legend: {
                          labels: { color: 'white' }
                        }
                      }
                    }}
                  />
                </div>
              )}

              {activeTab === 'economy' && (
                <div className="bg-gray-800 rounded-xl p-6">
                  <h2 className="text-xl font-bold mb-4">ê²½ì œ ì§€í‘œ ìƒê´€ê´€ê³„</h2>
                  <Bar
                    data={economicChartData}
                    options={{
                      responsive: true,
                      scales: {
                        y: {
                          beginAtZero: true,
                          min: -100,
                          max: 100,
                          ticks: {
                            color: 'white',
                            callback: (value) => value + '%'
                          },
                          grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                          ticks: { color: 'white' },
                          grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                      },
                      plugins: {
                        legend: {
                          labels: { color: 'white' }
                        }
                      }
                    }}
                  />
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  )
}