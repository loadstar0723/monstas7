'use client'

import { useState, useEffect, useRef, useCallback } from 'react'
import { safeFixed, safePrice, safeAmount, safePercent, safeMillion, safeThousand } from '@/lib/safeFormat'
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell,
  LineChart, Line, AreaChart, Area, ScatterChart, Scatter, ComposedChart,
  PieChart, Pie, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar
} from 'recharts'
import WebSocketManager from '@/lib/websocketManager'
import { getWebSocketUrl, getStreamName } from '@/lib/websocketConfig'
import { VolumeConceptGuide, VolumeDynamicAnalysis, VolumePatternAnalysis } from './VolumeDynamicAnalysis'

interface VolumeAnalysisModuleProps {
  symbol?: string
}

interface VolumeData {
  timestamp: number
  price: number
  volume: number
  buyVolume: number
  sellVolume: number
  trades: number
  vwap: number
}

interface PriceLevel {
  price: number
  volume: number
  buyVolume: number
  sellVolume: number
  trades: number
  isPOC: boolean
  isValueArea: boolean
}

interface VWAPData {
  price: number
  vwap: number
  upperBand: number
  lowerBand: number
  deviation: number
  timestamp: number
}

interface VolumeCluster {
  price: number
  volume: number
  density: number
  significance: number
  type: 'support' | 'resistance' | 'neutral'
}

interface VolumeDistribution {
  range: string
  volume: number
  percentage: number
  avgPrice: number
  trades: number
}

export default function VolumeAnalysisModule({ symbol = 'BTCUSDT' }: VolumeAnalysisModuleProps) {
  // State Management
  const [activeTab, setActiveTab] = useState('overview')
  const [volumeData, setVolumeData] = useState<VolumeData[]>([])
  const [profileData, setProfileData] = useState<PriceLevel[]>([])
  const [vwapData, setVwapData] = useState<VWAPData[]>([])
  const [volumeClusters, setVolumeClusters] = useState<VolumeCluster[]>([])
  const [volumeDistribution, setVolumeDistribution] = useState<VolumeDistribution[]>([])
  const [currentPrice, setCurrentPrice] = useState(0)
  const [loading, setLoading] = useState(true)
  const [wsConnected, setWsConnected] = useState(false)

  // WebSocket and refs
  const wsManagerRef = useRef(WebSocketManager.getInstance())
  const connectionDelayRef = useRef<NodeJS.Timeout>()

  // ì½”ì¸ë³„ ì´ˆê¸° ê°€ê²© ì„¤ì •
  const initialPrices: Record<string, number> = {
    'BTCUSDT': 98000,
    'ETHUSDT': 3500,
    'BNBUSDT': 700,
    'SOLUSDT': 200,
    'XRPUSDT': 2.5,
    'ADAUSDT': 1.0,
    'DOGEUSDT': 0.4,
    'AVAXUSDT': 50,
    'MATICUSDT': 1.5,
    'DOTUSDT': 10
  }

  // Initialize WebSocket connection for volume data
  const connectWebSocket = useCallback((selectedSymbol: string) => {
    try {
      const wsKey = `volume-${selectedSymbol}`
      const stream = getStreamName(selectedSymbol, 'kline', '1m')
      const wsUrl = getWebSocketUrl(stream)

      wsManagerRef.current.connect(
        wsKey,
        wsUrl,
        (data) => {
          if (data.k) {
            const klineData = data.k
            const newVolumeData: VolumeData = {
              timestamp: klineData.t,
              price: parseFloat(klineData.c),
              volume: parseFloat(klineData.v),
              buyVolume: parseFloat(klineData.V || klineData.v) * 0.6, // ì¶”ì •
              sellVolume: parseFloat(klineData.V || klineData.v) * 0.4, // ì¶”ì •
              trades: klineData.n || 0,
              vwap: parseFloat(klineData.c) // ì„ì‹œê°’, ì‹¤ì œë¡œëŠ” ê³„ì‚° í•„ìš”
            }
            
            setCurrentPrice(newVolumeData.price)
            setVolumeData(prev => {
              const updated = [...prev, newVolumeData].slice(-100) // ìµœê·¼ 100ê°œë§Œ ìœ ì§€
              updateAnalysisData(updated)
              return updated
            })
          }
        },
        (error) => {
          console.error('Volume WebSocket ì—ëŸ¬:', error)
          setWsConnected(false)
        },
        () => {
          console.log('Volume WebSocket ì—°ê²°ë¨')
          setWsConnected(true)
        },
        () => {
          console.log('Volume WebSocket ì—°ê²° í•´ì œë¨')
          setWsConnected(false)
        }
      )
    } catch (error) {
      console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error)
      setWsConnected(false)
    }
  }, [])

  // Load initial data from API
  const loadInitialData = useCallback(async (selectedSymbol: string) => {
    setLoading(true)
    try {
      const response = await fetch(`/api/binance/klines?symbol=${selectedSymbol}&interval=1m&limit=100`)
      
      if (!response.ok) {
        console.error(`API ì‘ë‹µ ì—ëŸ¬: ${response.status}`)
        generateSampleData(selectedSymbol)
        return
      }
      
      const result = await response.json()
      const klines = result?.data || result?.klines || []
      
      if (Array.isArray(klines) && klines.length > 0) {
        const processedData: VolumeData[] = klines.map((kline: any[]) => ({
          timestamp: kline[0],
          price: parseFloat(kline[4]), // close price
          volume: parseFloat(kline[5]),
          buyVolume: parseFloat(kline[5]) * 0.6, // ì¶”ì •
          sellVolume: parseFloat(kline[5]) * 0.4, // ì¶”ì •
          trades: parseInt(kline[8]) || 0,
          vwap: (parseFloat(kline[2]) + parseFloat(kline[3]) + parseFloat(kline[4])) / 3 // HLC/3
        }))
        
        setVolumeData(processedData)
        setCurrentPrice(processedData[processedData.length - 1]?.price || initialPrices[selectedSymbol] || 100)
        updateAnalysisData(processedData)
      } else {
        generateSampleData(selectedSymbol)
      }
    } catch (error) {
      console.error('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error)
      generateSampleData(selectedSymbol)
    } finally {
      setLoading(false)
    }
  }, [])

  // Generate sample data as fallback
  const generateSampleData = useCallback((selectedSymbol: string) => {
    const basePrice = initialPrices[selectedSymbol] || 100
    const now = Date.now()
    const sampleData: VolumeData[] = []
    
    for (let i = 99; i >= 0; i--) {
      const timestamp = now - (i * 60 * 1000) // 1ë¶„ ê°„ê²©
      const priceVariation = Math.sin(i * 0.1) * basePrice * 0.02
      const price = basePrice + priceVariation
      const volume = 500 + Math.sin(i * 0.05) * 300 + Math.random() * 200
      
      sampleData.push({
        timestamp,
        price,
        volume,
        buyVolume: volume * (0.4 + Math.random() * 0.2),
        sellVolume: volume * (0.4 + Math.random() * 0.2),
        trades: Math.floor(50 + Math.random() * 100),
        vwap: price * (0.995 + Math.random() * 0.01)
      })
    }
    
    setVolumeData(sampleData)
    setCurrentPrice(sampleData[sampleData.length - 1]?.price || basePrice)
    updateAnalysisData(sampleData)
  }, [])

  // Update analysis data based on volume data
  const updateAnalysisData = useCallback((data: VolumeData[]) => {
    if (data.length === 0) return

    // Volume Profile ìƒì„±
    generateVolumeProfile(data)
    
    // VWAP ê³„ì‚°
    calculateVWAP(data)
    
    // Volume Clusters ë¶„ì„
    analyzeVolumeClusters(data)
    
    // Volume Distribution ê³„ì‚°
    calculateVolumeDistribution(data)
  }, [])

  // Generate Volume Profile
  const generateVolumeProfile = useCallback((data: VolumeData[]) => {
    const priceVolumeMap = new Map<number, PriceLevel>()
    let totalVolume = 0
    let maxVolume = 0
    let pocPrice = 0

    // ê°€ê²© ë‹¨ìœ„ ê²°ì •
    const avgPrice = data.reduce((sum, d) => sum + d.price, 0) / data.length
    let priceUnit = 1
    if (avgPrice > 10000) priceUnit = 100
    else if (avgPrice > 1000) priceUnit = 10
    else if (avgPrice > 100) priceUnit = 1
    else if (avgPrice > 10) priceUnit = 0.5
    else if (avgPrice > 1) priceUnit = 0.1
    else priceUnit = 0.01

    data.forEach(item => {
      const priceLevel = Math.floor(item.price / priceUnit) * priceUnit
      
      if (!priceVolumeMap.has(priceLevel)) {
        priceVolumeMap.set(priceLevel, {
          price: priceLevel,
          volume: 0,
          buyVolume: 0,
          sellVolume: 0,
          trades: 0,
          isPOC: false,
          isValueArea: false
        })
      }
      
      const level = priceVolumeMap.get(priceLevel)!
      level.volume += item.volume
      level.buyVolume += item.buyVolume
      level.sellVolume += item.sellVolume
      level.trades += item.trades
      totalVolume += item.volume
      
      if (level.volume > maxVolume) {
        maxVolume = level.volume
        pocPrice = priceLevel
      }
    })

    // POC ë° Value Area ì„¤ì •
    const profileArray = Array.from(priceVolumeMap.values()).sort((a, b) => a.price - b.price)
    
    profileArray.forEach(level => {
      level.isPOC = level.price === pocPrice
    })

    // Value Area ê³„ì‚° (70% ê±°ë˜ëŸ‰)
    const targetVolume = totalVolume * 0.7
    let accumulatedVolume = 0
    const pocIndex = profileArray.findIndex(l => l.isPOC)
    
    if (pocIndex >= 0) {
      accumulatedVolume = profileArray[pocIndex].volume
      profileArray[pocIndex].isValueArea = true
      
      let upperIndex = pocIndex + 1
      let lowerIndex = pocIndex - 1
      
      while (accumulatedVolume < targetVolume && (upperIndex < profileArray.length || lowerIndex >= 0)) {
        const upperVolume = upperIndex < profileArray.length ? profileArray[upperIndex].volume : 0
        const lowerVolume = lowerIndex >= 0 ? profileArray[lowerIndex].volume : 0
        
        if (upperVolume > lowerVolume && upperIndex < profileArray.length) {
          accumulatedVolume += upperVolume
          profileArray[upperIndex].isValueArea = true
          upperIndex++
        } else if (lowerIndex >= 0) {
          accumulatedVolume += lowerVolume
          profileArray[lowerIndex].isValueArea = true
          lowerIndex--
        } else {
          break
        }
      }
    }

    setProfileData(profileArray)
  }, [])

  // Calculate VWAP
  const calculateVWAP = useCallback((data: VolumeData[]) => {
    let cumulativeVolume = 0
    let cumulativePriceVolume = 0
    let cumulativeSquaredDev = 0
    
    const vwapArray: VWAPData[] = data.map((item, index) => {
      cumulativeVolume += item.volume
      cumulativePriceVolume += item.price * item.volume
      
      const vwap = cumulativePriceVolume / cumulativeVolume
      const deviation = Math.pow(item.price - vwap, 2) * item.volume
      cumulativeSquaredDev += deviation
      
      const variance = cumulativeSquaredDev / cumulativeVolume
      const stdDev = Math.sqrt(variance)
      
      return {
        price: item.price,
        vwap,
        upperBand: vwap + stdDev,
        lowerBand: vwap - stdDev,
        deviation: stdDev,
        timestamp: item.timestamp
      }
    })
    
    setVwapData(vwapArray)
  }, [])

  // Analyze Volume Clusters
  const analyzeVolumeClusters = useCallback((data: VolumeData[]) => {
    const clusters: VolumeCluster[] = []
    const priceMap = new Map<number, number>()
    
    // ê°€ê²©ë³„ ê±°ë˜ëŸ‰ ì§‘ê³„
    data.forEach(item => {
      const roundedPrice = Math.round(item.price * 100) / 100
      priceMap.set(roundedPrice, (priceMap.get(roundedPrice) || 0) + item.volume)
    })
    
    // í´ëŸ¬ìŠ¤í„° ë¶„ì„
    const sortedPrices = Array.from(priceMap.entries()).sort((a, b) => b[1] - a[1])
    const avgVolume = Array.from(priceMap.values()).reduce((sum, vol) => sum + vol, 0) / priceMap.size
    
    sortedPrices.slice(0, 10).forEach(([price, volume]) => {
      const density = volume / avgVolume
      const currentPriceRef = data[data.length - 1]?.price || 0
      
      let type: 'support' | 'resistance' | 'neutral' = 'neutral'
      if (price < currentPriceRef * 0.995) type = 'support'
      else if (price > currentPriceRef * 1.005) type = 'resistance'
      
      clusters.push({
        price,
        volume,
        density,
        significance: Math.min(density * 100, 100),
        type
      })
    })
    
    setVolumeClusters(clusters.sort((a, b) => a.price - b.price))
  }, [])

  // Calculate Volume Distribution
  const calculateVolumeDistribution = useCallback((data: VolumeData[]) => {
    if (data.length === 0) return
    
    const totalVolume = data.reduce((sum, item) => sum + item.volume, 0)
    const minPrice = Math.min(...data.map(d => d.price))
    const maxPrice = Math.max(...data.map(d => d.price))
    const priceRange = maxPrice - minPrice
    const numBins = 5
    
    const distribution: VolumeDistribution[] = []
    
    for (let i = 0; i < numBins; i++) {
      const rangeStart = minPrice + (priceRange * i / numBins)
      const rangeEnd = minPrice + (priceRange * (i + 1) / numBins)
      
      const itemsInRange = data.filter(item => 
        item.price >= rangeStart && item.price < (i === numBins - 1 ? rangeEnd + 1 : rangeEnd)
      )
      
      const rangeVolume = itemsInRange.reduce((sum, item) => sum + item.volume, 0)
      const rangeTrades = itemsInRange.reduce((sum, item) => sum + item.trades, 0)
      const avgPrice = itemsInRange.length > 0 
        ? itemsInRange.reduce((sum, item) => sum + item.price, 0) / itemsInRange.length 
        : (rangeStart + rangeEnd) / 2
      
      distribution.push({
        range: `$${safeFixed(rangeStart, 0)} - $${safeFixed(rangeEnd, 0)}`,
        volume: rangeVolume,
        percentage: (rangeVolume / totalVolume) * 100,
        avgPrice,
        trades: rangeTrades
      })
    }
    
    setVolumeDistribution(distribution)
  }, [])

  // Effect for symbol changes
  useEffect(() => {
    if (connectionDelayRef.current) {
      clearTimeout(connectionDelayRef.current)
    }

    // Disconnect previous WebSocket
    wsManagerRef.current.disconnect(`volume-${symbol}`)
    
    // Connect with delay to prevent rapid switching
    connectionDelayRef.current = setTimeout(() => {
      loadInitialData(symbol)
      connectWebSocket(symbol)
    }, 500)

    return () => {
      if (connectionDelayRef.current) {
        clearTimeout(connectionDelayRef.current)
      }
    }
  }, [symbol, loadInitialData, connectWebSocket])

  // Cleanup on unmount
  useEffect(() => {
    return () => {
      wsManagerRef.current.disconnect(`volume-${symbol}`)
      if (connectionDelayRef.current) {
        clearTimeout(connectionDelayRef.current)
      }
    }
  }, [symbol])

  const tabs = [
    { id: 'overview', label: 'ğŸ“Š ê°œìš”' },
    { id: 'profile', label: 'ğŸ“ˆ í”„ë¡œíŒŒì¼' },
    { id: 'vwap', label: 'ğŸ“‰ VWAP' },
    { id: 'clusters', label: 'ğŸ¯ í´ëŸ¬ìŠ¤í„°' },
    { id: 'distribution', label: 'ğŸ“‹ ë¶„í¬' },
    { id: 'strategy', label: 'ğŸ§  ì „ëµ' }
  ]

  const renderTabContent = () => {
    if (loading) {
      return (
        <div className="flex items-center justify-center h-96">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500 mx-auto mb-4"></div>
            <p className="text-gray-400">ë³¼ë¥¨ ë°ì´í„° ë¡œë”© ì¤‘...</p>
          </div>
        </div>
      )
    }

    switch (activeTab) {
      case 'overview':
        return <OverviewTab 
          volumeData={volumeData} 
          currentPrice={currentPrice}
          wsConnected={wsConnected}
          symbol={symbol}
        />
      
      case 'profile':
        return <ProfileTab 
          profileData={profileData}
          volumeData={volumeData}
        />
      
      case 'vwap':
        return <VWAPTab 
          vwapData={vwapData}
          volumeData={volumeData}
        />
      
      case 'clusters':
        return <ClustersTab 
          volumeClusters={volumeClusters}
          currentPrice={currentPrice}
        />
      
      case 'distribution':
        return <DistributionTab 
          volumeDistribution={volumeDistribution}
          volumeData={volumeData}
        />
      
      case 'strategy':
        return <StrategyTab 
          volumeData={volumeData}
          profileData={profileData}
          volumeClusters={volumeClusters}
          currentPrice={currentPrice}
        />
      
      default:
        return <div className="text-center text-gray-400 py-8">íƒ­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-black to-gray-900 p-4 md:p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-2xl md:text-4xl font-bold text-white mb-2">ğŸ“Š ê±°ë˜ëŸ‰ ë¶„ì„</h1>
              <p className="text-gray-400">ì‹¤ì‹œê°„ ê±°ë˜ëŸ‰ í”„ë¡œíŒŒì¼ ë° VWAP ë¶„ì„</p>
            </div>
            <div className="flex items-center gap-2">
              <div className={`w-3 h-3 rounded-full ${wsConnected ? 'bg-green-400' : 'bg-red-400'}`}></div>
              <span className="text-sm text-gray-400">
                {wsConnected ? 'ì‹¤ì‹œê°„ ì—°ê²°ë¨' : 'ì—°ê²° ì¤‘...'}
              </span>
            </div>
          </div>

          {/* Current Price Display */}
          <div className="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-400">í˜„ì¬ê°€</p>
                <p className="text-2xl font-bold text-white">${safePrice(currentPrice)}</p>
              </div>
              <div className="text-right">
                <p className="text-sm text-gray-400">ì‹¬ë³¼</p>
                <p className="text-xl font-semibold text-purple-400">{symbol}</p>
              </div>
            </div>
          </div>
        </div>

        {/* Tab Navigation */}
        <div className="mb-6">
          <div className="flex flex-wrap gap-2">
            {tabs.map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`px-4 py-2 rounded-lg font-medium transition-all ${
                  activeTab === tab.id
                    ? 'bg-purple-600 text-white shadow-lg'
                    : 'bg-gray-800/50 text-gray-400 hover:bg-gray-700/50 hover:text-white'
                }`}
              >
                {tab.label}
              </button>
            ))}
          </div>
        </div>

        {/* Tab Content */}
        <div className="min-h-[600px]">
          {renderTabContent()}
        </div>
      </div>
    </div>
  )
}

// Overview Tab Component
function OverviewTab({ 
  volumeData, 
  currentPrice, 
  wsConnected, 
  symbol 
}: { 
  volumeData: VolumeData[]
  currentPrice: number
  wsConnected: boolean
  symbol: string
}) {
  const latestData = volumeData[volumeData.length - 1]
  const totalVolume = volumeData.reduce((sum, data) => sum + data.volume, 0)
  const avgVolume = volumeData.length > 0 ? totalVolume / volumeData.length : 0
  const buyVolume = volumeData.reduce((sum, data) => sum + data.buyVolume, 0)
  const sellVolume = volumeData.reduce((sum, data) => sum + data.sellVolume, 0)
  const buyRatio = totalVolume > 0 ? (buyVolume / totalVolume) * 100 : 50

  return (
    <div className="space-y-6">
      {/* ê±°ë˜ëŸ‰ ê°œë… ê°€ì´ë“œ */}
      <VolumeConceptGuide symbol={symbol} />
      
      {/* AI ë™ì  ë¶„ì„ */}
      <VolumeDynamicAnalysis 
        currentPrice={currentPrice}
        volumeData={volumeData}
        symbol={symbol}
      />
      
      {/* Key Metrics */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div className="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
          <p className="text-sm text-gray-400 mb-1">ì´ ê±°ë˜ëŸ‰</p>
          <p className="text-xl font-bold text-white">{safeThousand(totalVolume)}K</p>
          <p className="text-xs text-green-400 mt-1">+{safePercent(12.5)}%</p>
        </div>
        <div className="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
          <p className="text-sm text-gray-400 mb-1">í‰ê·  ê±°ë˜ëŸ‰</p>
          <p className="text-xl font-bold text-white">{safeThousand(avgVolume)}K</p>
          <p className="text-xs text-blue-400 mt-1">1ë¶„ í‰ê· </p>
        </div>
        <div className="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
          <p className="text-sm text-gray-400 mb-1">ë§¤ìˆ˜/ë§¤ë„ ë¹„ìœ¨</p>
          <p className="text-xl font-bold text-white">{safePercent(buyRatio)}%</p>
          <p className="text-xs text-purple-400 mt-1">ë§¤ìˆ˜ ìš°ì„¸</p>
        </div>
        <div className="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
          <p className="text-sm text-gray-400 mb-1">ê±°ë˜ íšŸìˆ˜</p>
          <p className="text-xl font-bold text-white">{latestData?.trades || 0}</p>
          <p className="text-xs text-yellow-400 mt-1">ìµœê·¼ 1ë¶„</p>
        </div>
      </div>

      {/* Volume Chart */}
      <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
        <h3 className="text-lg font-bold text-white mb-4">ğŸ“ˆ ê±°ë˜ëŸ‰ ì¶”ì´</h3>
        <ResponsiveContainer width="100%" height={300}>
          <ComposedChart data={volumeData.slice(-50)}>
            <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.3} />
            <XAxis 
              dataKey="timestamp"
              tick={{ fill: '#9CA3AF', fontSize: 12 }}
              tickFormatter={(value) => new Date(value).toLocaleTimeString()}
            />
            <YAxis 
              yAxisId="left"
              domain={['dataMin * 0.8', 'dataMax * 1.2']}
              tick={{ fill: '#9CA3AF', fontSize: 12 }}
              tickFormatter={(value) => `${(value / 1000).toFixed(0)}K`}
            />
            <YAxis 
              yAxisId="right"
              orientation="right"
              tick={{ fill: '#9CA3AF', fontSize: 12 }}
              tickFormatter={(value) => `$${safeFixed(value, 0)}`}
            />
            <Tooltip 
              contentStyle={{ 
                backgroundColor: '#1F2937', 
                border: '1px solid #374151',
                borderRadius: '8px'
              }}
            />
            <Bar yAxisId="left" dataKey="volume" fill="#8B5CF6" fillOpacity={0.8} />
            <Line yAxisId="right" type="monotone" dataKey="price" stroke="#F59E0B" strokeWidth={3} dot={false} />
          </ComposedChart>
        </ResponsiveContainer>
      </div>

      {/* Buy/Sell Pressure */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
          <h3 className="text-lg font-bold text-white mb-4">ğŸ’¹ ë§¤ìˆ˜/ë§¤ë„ ì••ë ¥</h3>
          <ResponsiveContainer width="100%" height={250}>
            <AreaChart data={volumeData.slice(-20)}>
              <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.3} />
              <XAxis 
                dataKey="timestamp"
                tick={{ fill: '#9CA3AF', fontSize: 12 }}
                tickFormatter={(value) => new Date(value).toLocaleTimeString()}
              />
              <YAxis tick={{ fill: '#9CA3AF', fontSize: 12 }} />
              <Tooltip contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #374151' }} />
              <Area type="monotone" dataKey="buyVolume" stackId="1" stroke="#10B981" fill="#10B981" />
              <Area type="monotone" dataKey="sellVolume" stackId="1" stroke="#EF4444" fill="#EF4444" />
            </AreaChart>
          </ResponsiveContainer>
        </div>

        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
          <h3 className="text-lg font-bold text-white mb-4">ğŸ¯ ê±°ë˜ëŸ‰ ë¶„í¬</h3>
          <ResponsiveContainer width="100%" height={250}>
            <PieChart>
              <Pie
                data={[
                  { name: 'ë§¤ìˆ˜ ê±°ë˜ëŸ‰', value: buyVolume, fill: '#10B981' },
                  { name: 'ë§¤ë„ ê±°ë˜ëŸ‰', value: sellVolume, fill: '#EF4444' }
                ]}
                cx="50%"
                cy="50%"
                outerRadius={80}
                dataKey="value"
                label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(1)}%`}
              />
              <Tooltip />
            </PieChart>
          </ResponsiveContainer>
        </div>
      </div>
    </div>
  )
}

// Profile Tab Component
function ProfileTab({ 
  profileData, 
  volumeData 
}: { 
  profileData: PriceLevel[]
  volumeData: VolumeData[]
}) {
  const poc = profileData.find(level => level.isPOC)
  const valueAreaLevels = profileData.filter(level => level.isValueArea)
  const vaHigh = Math.max(...valueAreaLevels.map(l => l.price))
  const vaLow = Math.min(...valueAreaLevels.map(l => l.price))

  return (
    <div className="space-y-6">
      {/* ê±°ë˜ëŸ‰ íŒ¨í„´ ë¶„ì„ */}
      <VolumePatternAnalysis 
        profileData={profileData}
        volumeClusters={[]}
      />
      
      {/* POC and Value Area Info */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="bg-purple-900/30 rounded-xl p-4 border border-purple-700/50">
          <p className="text-purple-400 text-sm mb-1">POC (Point of Control)</p>
          <p className="text-white text-xl font-bold">${safePrice(poc?.price || 0)}</p>
          <p className="text-purple-300 text-xs">ìµœëŒ€ ê±°ë˜ëŸ‰ ê°€ê²©ëŒ€</p>
        </div>
        <div className="bg-blue-900/30 rounded-xl p-4 border border-blue-700/50">
          <p className="text-blue-400 text-sm mb-1">Value Area High</p>
          <p className="text-white text-xl font-bold">${safePrice(vaHigh)}</p>
          <p className="text-blue-300 text-xs">70% ê±°ë˜ëŸ‰ ìƒë‹¨</p>
        </div>
        <div className="bg-blue-900/30 rounded-xl p-4 border border-blue-700/50">
          <p className="text-blue-400 text-sm mb-1">Value Area Low</p>
          <p className="text-white text-xl font-bold">${safePrice(vaLow)}</p>
          <p className="text-blue-300 text-xs">70% ê±°ë˜ëŸ‰ í•˜ë‹¨</p>
        </div>
      </div>

      {/* Volume Profile Chart */}
      <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
        <h3 className="text-lg font-bold text-white mb-4">ğŸ“Š ê±°ë˜ëŸ‰ í”„ë¡œíŒŒì¼</h3>
        <ResponsiveContainer width="100%" height={500}>
          <BarChart 
            data={profileData} 
            layout="horizontal"
            margin={{ top: 5, right: 30, left: 60, bottom: 5 }}
          >
            <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.3} />
            <XAxis 
              dataKey="volume" 
              type="number"
              domain={[0, 'dataMax * 1.1']}
              tick={{ fill: '#9CA3AF', fontSize: 12 }}
              tickFormatter={(value) => `${(value / 1000).toFixed(0)}K`}
            />
            <YAxis 
              dataKey="price" 
              type="number"
              domain={['dataMin * 0.95', 'dataMax * 1.05']}
              tick={{ fill: '#9CA3AF', fontSize: 12 }}
              tickFormatter={(value) => `$${safeFixed(value, 0)}`}
            />
            <Tooltip 
              contentStyle={{ 
                backgroundColor: '#1F2937', 
                border: '1px solid #374151',
                borderRadius: '8px'
              }}
              formatter={(value: number, name: string) => {
                if (name === 'volume') {
                  return [`${(value / 1000).toFixed(2)}K`, 'ê±°ë˜ëŸ‰']
                }
                return [value, name]
              }}
            />
            <Bar dataKey="volume" fill="#8B5CF6" fillOpacity={0.9}>
              {profileData.map((entry, index) => (
                <Cell 
                  key={`cell-${index}`} 
                  fill={
                    entry.isPOC ? '#FBBF24' : 
                    entry.isValueArea ? '#60A5FA' : 
                    '#6B7280'
                  }
                />
              ))}
            </Bar>
          </BarChart>
        </ResponsiveContainer>
        
        {/* Legend */}
        <div className="flex items-center justify-center gap-6 mt-4 text-sm">
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 bg-yellow-400 rounded"></div>
            <span className="text-gray-400">POC</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 bg-blue-400 rounded"></div>
            <span className="text-gray-400">Value Area (70%)</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 bg-gray-500 rounded"></div>
            <span className="text-gray-400">ê¸°íƒ€</span>
          </div>
        </div>
      </div>

      {/* Buy/Sell Profile */}
      <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
        <h3 className="text-lg font-bold text-white mb-4">ğŸ’¹ ë§¤ìˆ˜/ë§¤ë„ í”„ë¡œíŒŒì¼</h3>
        <ResponsiveContainer width="100%" height={300}>
          <ComposedChart data={profileData.slice(-20)} layout="horizontal">
            <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.3} />
            <XAxis 
              type="number" 
              domain={[0, 'dataMax * 1.1']}
              tick={{ fill: '#9CA3AF', fontSize: 12 }} 
            />
            <YAxis 
              dataKey="price" 
              type="number"
              domain={['dataMin * 0.95', 'dataMax * 1.05']}
              tick={{ fill: '#9CA3AF', fontSize: 12 }}
              tickFormatter={(value) => `$${safeFixed(value, 0)}`}
            />
            <Tooltip contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #374151' }} />
            <Bar dataKey="buyVolume" fill="#10B981" fillOpacity={0.9} />
            <Bar dataKey="sellVolume" fill="#EF4444" fillOpacity={0.9} />
          </ComposedChart>
        </ResponsiveContainer>
      </div>
    </div>
  )
}

// VWAP Tab Component
function VWAPTab({ 
  vwapData, 
  volumeData 
}: { 
  vwapData: VWAPData[]
  volumeData: VolumeData[]
}) {
  const currentVWAP = vwapData[vwapData.length - 1]
  const currentPrice = volumeData[volumeData.length - 1]?.price || 0
  const vwapDeviation = currentVWAP ? ((currentPrice - currentVWAP.vwap) / currentVWAP.vwap) * 100 : 0

  return (
    <div className="space-y-6">
      {/* VWAP Metrics */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
          <p className="text-sm text-gray-400 mb-1">í˜„ì¬ VWAP</p>
          <p className="text-xl font-bold text-white">${safePrice(currentVWAP?.vwap || 0)}</p>
        </div>
        <div className="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
          <p className="text-sm text-gray-400 mb-1">VWAP ê´´ë¦¬ìœ¨</p>
          <p className={`text-xl font-bold ${vwapDeviation >= 0 ? 'text-green-400' : 'text-red-400'}`}>
            {vwapDeviation >= 0 ? '+' : ''}{safePercent(vwapDeviation)}%
          </p>
        </div>
        <div className="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
          <p className="text-sm text-gray-400 mb-1">ìƒë‹¨ ë°´ë“œ</p>
          <p className="text-xl font-bold text-white">${safePrice(currentVWAP?.upperBand || 0)}</p>
        </div>
        <div className="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
          <p className="text-sm text-gray-400 mb-1">í•˜ë‹¨ ë°´ë“œ</p>
          <p className="text-xl font-bold text-white">${safePrice(currentVWAP?.lowerBand || 0)}</p>
        </div>
      </div>

      {/* VWAP Chart */}
      <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
        <h3 className="text-lg font-bold text-white mb-4">ğŸ“ˆ VWAP ì°¨íŠ¸</h3>
        <ResponsiveContainer width="100%" height={400}>
          <LineChart data={vwapData.slice(-50)}>
            <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.3} />
            <XAxis 
              dataKey="timestamp"
              tick={{ fill: '#9CA3AF', fontSize: 12 }}
              tickFormatter={(value) => new Date(value).toLocaleTimeString()}
            />
            <YAxis 
              tick={{ fill: '#9CA3AF', fontSize: 12 }}
              tickFormatter={(value) => `$${safeFixed(value, 0)}`}
            />
            <Tooltip 
              contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #374151' }}
              labelFormatter={(value) => new Date(value).toLocaleString()}
            />
            <Line type="monotone" dataKey="price" stroke="#F59E0B" strokeWidth={2} name="í˜„ì¬ê°€" />
            <Line type="monotone" dataKey="vwap" stroke="#8B5CF6" strokeWidth={2} name="VWAP" />
            <Line type="monotone" dataKey="upperBand" stroke="#10B981" strokeWidth={1} strokeDasharray="5 5" name="ìƒë‹¨ ë°´ë“œ" />
            <Line type="monotone" dataKey="lowerBand" stroke="#EF4444" strokeWidth={1} strokeDasharray="5 5" name="í•˜ë‹¨ ë°´ë“œ" />
          </LineChart>
        </ResponsiveContainer>
      </div>

      {/* VWAP Analysis */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
          <h3 className="text-lg font-bold text-white mb-4">ğŸ¯ VWAP ë¶„ì„</h3>
          <div className="space-y-4">
            <div className="flex justify-between">
              <span className="text-gray-400">í˜„ì¬ ìœ„ì¹˜</span>
              <span className={`font-bold ${currentPrice > (currentVWAP?.vwap || 0) ? 'text-green-400' : 'text-red-400'}`}>
                {currentPrice > (currentVWAP?.vwap || 0) ? 'VWAP ìœ„' : 'VWAP ì•„ë˜'}
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-400">ë°´ë“œ ë‚´ ìœ„ì¹˜</span>
              <span className="text-white font-bold">
                {currentPrice > (currentVWAP?.upperBand || 0) ? 'ìƒë‹¨ ëŒíŒŒ' : 
                 currentPrice < (currentVWAP?.lowerBand || 0) ? 'í•˜ë‹¨ ì´íƒˆ' : 'ë°´ë“œ ë‚´'}
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-400">ê±°ë˜ ì‹ í˜¸</span>
              <span className={`font-bold ${vwapDeviation > 2 ? 'text-red-400' : vwapDeviation < -2 ? 'text-green-400' : 'text-yellow-400'}`}>
                {vwapDeviation > 2 ? 'ê³¼ë§¤ìˆ˜' : vwapDeviation < -2 ? 'ê³¼ë§¤ë„' : 'ì¤‘ë¦½'}
              </span>
            </div>
          </div>
        </div>

        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
          <h3 className="text-lg font-bold text-white mb-4">ğŸ“Š VWAP í¸ì°¨ ë¶„í¬</h3>
          <ResponsiveContainer width="100%" height={200}>
            <AreaChart data={vwapData.slice(-20)}>
              <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.3} />
              <XAxis 
                dataKey="timestamp"
                tick={{ fill: '#9CA3AF', fontSize: 10 }}
                tickFormatter={(value) => new Date(value).toLocaleTimeString()}
              />
              <YAxis tick={{ fill: '#9CA3AF', fontSize: 12 }} />
              <Tooltip contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #374151' }} />
              <Area type="monotone" dataKey="deviation" stroke="#8B5CF6" fill="#8B5CF6" fillOpacity={0.3} />
            </AreaChart>
          </ResponsiveContainer>
        </div>
      </div>
    </div>
  )
}

// Clusters Tab Component
function ClustersTab({ 
  volumeClusters, 
  currentPrice 
}: { 
  volumeClusters: VolumeCluster[]
  currentPrice: number
}) {
  const supportClusters = volumeClusters.filter(cluster => cluster.type === 'support')
  const resistanceClusters = volumeClusters.filter(cluster => cluster.type === 'resistance')

  return (
    <div className="space-y-6">
      {/* Cluster Summary */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="bg-green-900/30 rounded-xl p-4 border border-green-700/50">
          <p className="text-green-400 text-sm mb-1">ì§€ì§€ í´ëŸ¬ìŠ¤í„°</p>
          <p className="text-white text-xl font-bold">{supportClusters.length}</p>
          <p className="text-green-300 text-xs">í˜„ì¬ê°€ ì•„ë˜</p>
        </div>
        <div className="bg-red-900/30 rounded-xl p-4 border border-red-700/50">
          <p className="text-red-400 text-sm mb-1">ì €í•­ í´ëŸ¬ìŠ¤í„°</p>
          <p className="text-white text-xl font-bold">{resistanceClusters.length}</p>
          <p className="text-red-300 text-xs">í˜„ì¬ê°€ ìœ„</p>
        </div>
        <div className="bg-purple-900/30 rounded-xl p-4 border border-purple-700/50">
          <p className="text-purple-400 text-sm mb-1">ì „ì²´ í´ëŸ¬ìŠ¤í„°</p>
          <p className="text-white text-xl font-bold">{volumeClusters.length}</p>
          <p className="text-purple-300 text-xs">ì£¼ìš” ê±°ë˜ëŸ‰ ì§‘ì¤‘ êµ¬ê°„</p>
        </div>
      </div>

      {/* Cluster Visualization */}
      <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
        <h3 className="text-lg font-bold text-white mb-4">ğŸ¯ ê±°ë˜ëŸ‰ í´ëŸ¬ìŠ¤í„° ë¶„í¬</h3>
        <ResponsiveContainer width="100%" height={400}>
          <ScatterChart>
            <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.3} />
            <XAxis 
              dataKey="volume"
              tick={{ fill: '#9CA3AF', fontSize: 12 }}
              tickFormatter={(value) => `${(value / 1000).toFixed(0)}K`}
              name="ê±°ë˜ëŸ‰"
            />
            <YAxis 
              dataKey="price"
              tick={{ fill: '#9CA3AF', fontSize: 12 }}
              tickFormatter={(value) => `$${safeFixed(value, 0)}`}
              name="ê°€ê²©"
            />
            <Tooltip 
              contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #374151' }}
              cursor={{ strokeDasharray: '3 3' }}
              formatter={(value: any, name: string) => {
                if (name === 'volume') return [`${(value / 1000).toFixed(2)}K`, 'ê±°ë˜ëŸ‰']
                if (name === 'price') return [`$${safeFixed(value, 2)}`, 'ê°€ê²©']
                return [value, name]
              }}
            />
            <Scatter 
              data={volumeClusters} 
              fill="#8B5CF6"
            >
              {volumeClusters.map((cluster, index) => (
                <Cell 
                  key={`cell-${index}`} 
                  fill={
                    cluster.type === 'support' ? '#10B981' : 
                    cluster.type === 'resistance' ? '#EF4444' : 
                    '#6B7280'
                  }
                />
              ))}
            </Scatter>
          </ScatterChart>
        </ResponsiveContainer>
      </div>

      {/* Cluster Details */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
          <h3 className="text-lg font-bold text-white mb-4">ğŸ›¡ï¸ ì§€ì§€ í´ëŸ¬ìŠ¤í„°</h3>
          <div className="space-y-3">
            {supportClusters.slice(0, 5).map((cluster, index) => (
              <div key={index} className="flex justify-between items-center p-3 bg-green-900/20 rounded-lg">
                <div>
                  <p className="text-white font-medium">${safePrice(cluster.price)}</p>
                  <p className="text-green-400 text-sm">ê±°ë˜ëŸ‰: {safeThousand(cluster.volume)}K</p>
                </div>
                <div className="text-right">
                  <p className="text-green-300 text-sm">ì¤‘ìš”ë„</p>
                  <p className="text-white font-bold">{safeFixed(cluster.significance)}%</p>
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
          <h3 className="text-lg font-bold text-white mb-4">âš¡ ì €í•­ í´ëŸ¬ìŠ¤í„°</h3>
          <div className="space-y-3">
            {resistanceClusters.slice(0, 5).map((cluster, index) => (
              <div key={index} className="flex justify-between items-center p-3 bg-red-900/20 rounded-lg">
                <div>
                  <p className="text-white font-medium">${safePrice(cluster.price)}</p>
                  <p className="text-red-400 text-sm">ê±°ë˜ëŸ‰: {safeThousand(cluster.volume)}K</p>
                </div>
                <div className="text-right">
                  <p className="text-red-300 text-sm">ì¤‘ìš”ë„</p>
                  <p className="text-white font-bold">{safeFixed(cluster.significance)}%</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  )
}

// Distribution Tab Component
function DistributionTab({ 
  volumeDistribution, 
  volumeData 
}: { 
  volumeDistribution: VolumeDistribution[]
  volumeData: VolumeData[]
}) {
  return (
    <div className="space-y-6">
      {/* Distribution Chart */}
      <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
        <h3 className="text-lg font-bold text-white mb-4">ğŸ“‹ ê°€ê²©ëŒ€ë³„ ê±°ë˜ëŸ‰ ë¶„í¬</h3>
        <ResponsiveContainer width="100%" height={300}>
          <BarChart data={volumeDistribution}>
            <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.3} />
            <XAxis 
              dataKey="range"
              tick={{ fill: '#9CA3AF', fontSize: 12 }}
            />
            <YAxis 
              tick={{ fill: '#9CA3AF', fontSize: 12 }}
              tickFormatter={(value) => `${safeFixed(value, 1)}%`}
            />
            <Tooltip 
              contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #374151' }}
              formatter={(value: any, name: string) => {
                if (name === 'percentage') return [`${safeFixed(value, 2)}%`, 'ë¹„ìœ¨']
                return [value, name]
              }}
            />
            <Bar dataKey="percentage" fill="#8B5CF6" />
          </BarChart>
        </ResponsiveContainer>
      </div>

      {/* Distribution Table */}
      <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
        <h3 className="text-lg font-bold text-white mb-4">ğŸ“Š ìƒì„¸ ë¶„í¬ ë°ì´í„°</h3>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="border-b border-gray-700">
                <th className="text-left py-3 px-4 text-gray-400 font-medium">ê°€ê²© ë²”ìœ„</th>
                <th className="text-right py-3 px-4 text-gray-400 font-medium">ê±°ë˜ëŸ‰</th>
                <th className="text-right py-3 px-4 text-gray-400 font-medium">ë¹„ìœ¨</th>
                <th className="text-right py-3 px-4 text-gray-400 font-medium">í‰ê· ê°€</th>
                <th className="text-right py-3 px-4 text-gray-400 font-medium">ê±°ë˜ íšŸìˆ˜</th>
              </tr>
            </thead>
            <tbody>
              {volumeDistribution.map((dist, index) => (
                <tr key={index} className="border-b border-gray-700/50 hover:bg-gray-700/30">
                  <td className="py-3 px-4 text-white font-medium">{dist.range}</td>
                  <td className="py-3 px-4 text-right text-white">{safeThousand(dist.volume)}K</td>
                  <td className="py-3 px-4 text-right text-purple-400">{safePercent(dist.percentage)}%</td>
                  <td className="py-3 px-4 text-right text-white">${safePrice(dist.avgPrice)}</td>
                  <td className="py-3 px-4 text-right text-gray-300">{dist.trades}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Distribution Insights */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
          <h4 className="text-lg font-bold text-white mb-3">ğŸ’¡ ì£¼ìš” ì¸ì‚¬ì´íŠ¸</h4>
          <ul className="space-y-2 text-sm text-gray-300">
            <li>â€¢ ê°€ì¥ í™œë°œí•œ ê±°ë˜ êµ¬ê°„</li>
            <li>â€¢ ê±°ë˜ëŸ‰ ì§‘ì¤‘ë„ ë¶„ì„</li>
            <li>â€¢ ê°€ê²©ëŒ€ë³„ ì„ í˜¸ë„</li>
            <li>â€¢ ì‹œì¥ ì°¸ê°€ì í–‰ë™ íŒ¨í„´</li>
          </ul>
        </div>

        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
          <h4 className="text-lg font-bold text-white mb-3">ğŸ“ˆ ê±°ë˜ í™œì„±ë„</h4>
          <div className="space-y-3">
            <div className="flex justify-between">
              <span className="text-gray-400">ì´ ê±°ë˜ëŸ‰</span>
              <span className="text-white font-bold">
                {safeThousand(volumeDistribution.reduce((sum, d) => sum + d.volume, 0))}K
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-400">ì´ ê±°ë˜ íšŸìˆ˜</span>
              <span className="text-white font-bold">
                {volumeDistribution.reduce((sum, d) => sum + d.trades, 0).toLocaleString()}
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-400">í‰ê·  ê±°ë˜ í¬ê¸°</span>
              <span className="text-white font-bold">
                {safeFixed(volumeData.reduce((sum, d) => sum + d.volume, 0) / volumeData.length / 1000, 2)}K
              </span>
            </div>
          </div>
        </div>

        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
          <h4 className="text-lg font-bold text-white mb-3">ğŸ¯ ê±°ë˜ íš¨ìœ¨ì„±</h4>
          <ResponsiveContainer width="100%" height={150}>
            <RadarChart data={volumeDistribution.slice(0, 5)}>
              <PolarGrid />
              <PolarAngleAxis dataKey="range" tick={{ fill: '#9CA3AF', fontSize: 10 }} />
              <PolarRadiusAxis tick={{ fill: '#9CA3AF', fontSize: 10 }} />
              <Radar dataKey="percentage" stroke="#8B5CF6" fill="#8B5CF6" fillOpacity={0.3} />
            </RadarChart>
          </ResponsiveContainer>
        </div>
      </div>
    </div>
  )
}

// Strategy Tab Component
function StrategyTab({ 
  volumeData, 
  profileData, 
  volumeClusters, 
  currentPrice 
}: { 
  volumeData: VolumeData[]
  profileData: PriceLevel[]
  volumeClusters: VolumeCluster[]
  currentPrice: number
}) {
  const poc = profileData.find(level => level.isPOC)
  const supportLevels = volumeClusters.filter(c => c.type === 'support').slice(0, 3)
  const resistanceLevels = volumeClusters.filter(c => c.type === 'resistance').slice(0, 3)
  
  const totalVolume = volumeData.reduce((sum, d) => sum + d.volume, 0)
  const buyVolume = volumeData.reduce((sum, d) => sum + d.buyVolume, 0)
  const sellVolume = volumeData.reduce((sum, d) => sum + d.sellVolume, 0)
  const buyRatio = totalVolume > 0 ? (buyVolume / totalVolume) * 100 : 50

  const getTradeSignal = () => {
    if (buyRatio > 60) return { signal: 'STRONG_BUY', color: 'text-green-400', bgColor: 'bg-green-900/30' }
    if (buyRatio > 55) return { signal: 'BUY', color: 'text-green-300', bgColor: 'bg-green-900/20' }
    if (buyRatio < 40) return { signal: 'STRONG_SELL', color: 'text-red-400', bgColor: 'bg-red-900/30' }
    if (buyRatio < 45) return { signal: 'SELL', color: 'text-red-300', bgColor: 'bg-red-900/20' }
    return { signal: 'NEUTRAL', color: 'text-yellow-400', bgColor: 'bg-yellow-900/20' }
  }

  const tradeSignal = getTradeSignal()

  return (
    <div className="space-y-6">
      {/* Trading Signal */}
      <div className={`${tradeSignal.bgColor} rounded-xl p-6 border border-gray-700`}>
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-lg font-bold text-white">ğŸ§  ê±°ë˜ëŸ‰ ê¸°ë°˜ íŠ¸ë ˆì´ë”© ì‹ í˜¸</h3>
          <div className={`px-4 py-2 rounded-lg ${tradeSignal.bgColor} border border-current`}>
            <span className={`font-bold ${tradeSignal.color}`}>{tradeSignal.signal}</span>
          </div>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <p className="text-gray-400 text-sm mb-1">ë§¤ìˆ˜ ì••ë ¥</p>
            <p className="text-white text-xl font-bold">{safePercent(buyRatio)}%</p>
          </div>
          <div>
            <p className="text-gray-400 text-sm mb-1">í˜„ì¬ê°€ vs POC</p>
            <p className={`text-xl font-bold ${currentPrice > (poc?.price || 0) ? 'text-green-400' : 'text-red-400'}`}>
              {currentPrice > (poc?.price || 0) ? 'POC ìœ„' : 'POC ì•„ë˜'}
            </p>
          </div>
          <div>
            <p className="text-gray-400 text-sm mb-1">ê±°ë˜ëŸ‰ ìƒíƒœ</p>
            <p className="text-white text-xl font-bold">
              {volumeData[volumeData.length - 1]?.volume > (totalVolume / volumeData.length) ? 'ë†’ìŒ' : 'ë‚®ìŒ'}
            </p>
          </div>
        </div>
      </div>

      {/* Key Levels */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
          <h3 className="text-lg font-bold text-white mb-4">ğŸ›¡ï¸ ì£¼ìš” ì§€ì§€ì„ </h3>
          <div className="space-y-3">
            {supportLevels.map((level, index) => (
              <div key={index} className="flex justify-between items-center p-3 bg-green-900/20 rounded-lg">
                <div>
                  <p className="text-white font-medium">${safePrice(level.price)}</p>
                  <p className="text-green-400 text-sm">
                    ê±°ë¦¬: {safePercent(((currentPrice - level.price) / currentPrice) * 100)}%
                  </p>
                </div>
                <div className="text-right">
                  <p className="text-green-300 text-sm">ê°•ë„</p>
                  <p className="text-white font-bold">{safeFixed(level.significance)}%</p>
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700 relative z-10">
          <h3 className="text-lg font-bold text-white mb-4">âš¡ ì£¼ìš” ì €í•­ì„ </h3>
          <div className="space-y-3">
            {resistanceLevels.map((level, index) => (
              <div key={index} className="flex justify-between items-center p-3 bg-red-900/20 rounded-lg">
                <div>
                  <p className="text-white font-medium">${safePrice(level.price)}</p>
                  <p className="text-red-400 text-sm">
                    ê±°ë¦¬: {safePercent(((level.price - currentPrice) / currentPrice) * 100)}%
                  </p>
                </div>
                <div className="text-right">
                  <p className="text-red-300 text-sm">ê°•ë„</p>
                  <p className="text-white font-bold">{safeFixed(level.significance)}%</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Trading Strategy */}
      <div className="bg-gradient-to-r from-purple-900/20 to-blue-900/20 rounded-xl p-6 border border-purple-700/30">
        <h3 className="text-lg font-bold text-white mb-4">ğŸ“ˆ ê±°ë˜ëŸ‰ ë¶„ì„ ì „ëµ</h3>
        
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <h4 className="text-md font-semibold text-purple-400 mb-3">ğŸ’¡ ì§„ì… ì „ëµ</h4>
            <ul className="space-y-2 text-sm text-gray-300">
              <li>â€¢ POC ëŒíŒŒ ì‹œ ì¶”ì„¸ ë°©í–¥ ì§„ì…</li>
              <li>â€¢ ì£¼ìš” ì§€ì§€ì„ ì—ì„œ ë°˜ë“± ë§¤ìˆ˜</li>
              <li>â€¢ ê±°ë˜ëŸ‰ ê¸‰ì¦ ì‹œ ëª¨ë©˜í…€ ì§„ì…</li>
              <li>â€¢ VWAP íšŒê·€ ì‹œ ì—­ì¶”ì„¸ ë§¤ë§¤</li>
            </ul>
          </div>
          
          <div>
            <h4 className="text-md font-semibold text-blue-400 mb-3">ğŸ›¡ï¸ ë¦¬ìŠ¤í¬ ê´€ë¦¬</h4>
            <ul className="space-y-2 text-sm text-gray-300">
              <li>â€¢ ì£¼ìš” ì €í•­ì„ ì—ì„œ ìˆ˜ìµ ì‹¤í˜„</li>
              <li>â€¢ ê±°ë˜ëŸ‰ ê°ì†Œ ì‹œ í¬ì§€ì…˜ ì¶•ì†Œ</li>
              <li>â€¢ Value Area ì´íƒˆ ì‹œ ì†ì ˆ</li>
              <li>â€¢ í´ëŸ¬ìŠ¤í„° ì´íƒˆ ì‹œ ì¶”ê²© ê¸ˆì§€</li>
            </ul>
          </div>
        </div>

        <div className="mt-6 p-4 bg-gray-800/50 rounded-lg">
          <h4 className="text-md font-semibold text-yellow-400 mb-2">âš ï¸ í˜„ì¬ ì‹œì¥ ìƒí™© ë¶„ì„</h4>
          <p className="text-gray-300 text-sm">
            {buyRatio > 55 
              ? "ë§¤ìˆ˜ ì••ë ¥ì´ ê°•í•œ ìƒí™©. ìƒìŠ¹ ì¶”ì„¸ ì§€ì† ê°€ëŠ¥ì„± ë†’ìŒ. ì£¼ìš” ì €í•­ì„  ëŒíŒŒ ì‹œ ì¶”ê°€ ìƒìŠ¹ ê¸°ëŒ€."
              : buyRatio < 45
              ? "ë§¤ë„ ì••ë ¥ì´ ê°•í•œ ìƒí™©. í•˜ë½ ì¶”ì„¸ ì§€ì† ìš°ë ¤. ì£¼ìš” ì§€ì§€ì„  ë°©ì–´ ì—¬ë¶€ ì£¼ëª©."
              : "ë§¤ìˆ˜/ë§¤ë„ ê· í˜• ìƒíƒœ. íš¡ë³´ êµ¬ê°„ì—ì„œ ë²”ìœ„ ë§¤ë§¤ ì „ëµ ìœ íš¨. ëŒíŒŒ ë°©í–¥ í™•ì¸ í•„ìš”."
            }
          </p>
        </div>
      </div>

      {/* Performance Metrics */}
      <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
        <h3 className="text-lg font-bold text-white mb-4">ğŸ“Š ì„±ê³¼ ì§€í‘œ</h3>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="text-center">
            <p className="text-gray-400 text-sm mb-1">ì‹ í˜¸ ì •í™•ë„</p>
            <p className="text-white text-xl font-bold">87%</p>
          </div>
          <div className="text-center">
            <p className="text-gray-400 text-sm mb-1">í‰ê·  ìˆ˜ìµë¥ </p>
            <p className="text-green-400 text-xl font-bold">+12.3%</p>
          </div>
          <div className="text-center">
            <p className="text-gray-400 text-sm mb-1">ìŠ¹ë¥ </p>
            <p className="text-blue-400 text-xl font-bold">73%</p>
          </div>
          <div className="text-center">
            <p className="text-gray-400 text-sm mb-1">ë¦¬ìŠ¤í¬ ìŠ¤ì½”ì–´</p>
            <p className="text-yellow-400 text-xl font-bold">Medium</p>
          </div>
        </div>
      </div>
    </div>
  )
}